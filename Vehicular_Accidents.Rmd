---
title: "Vehicular Accidents Restructuring"
author: "William Kopans"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    theme: paper
    fig.width: 10 # Does this work?
    fig.height: 10 # Does this work?
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

library(here)
knitr::opts_chunk$set(echo = TRUE,
                      cache = TRUE,
                      cache.path = here::here(".cache"),
                      cache.size = 1500,
                      cache.lazy = TRUE,
                      cache.rebuild = TRUE,
                      cache.extra = list(png = here::here("images/"), pdf = here::here("documents/")))

```

# Remember to remove SetWD and use "tabs" to group similar plots
``` {r Import Dataset and libraries, message=FALSE}
setwd("/Volumes/Courses/ES218_A_SP/wokopa26/Vehicular accidents/Apr26")
library(ggplot2)
library(tidyverse)
library(lubridate)
library(ggridges)

Accidents_Original <- readRDS("farsp.RDS")

alcohol <- read.csv("alcohol.csv")
alcohol <- alcohol %>% 
  mutate(description = if_else(description %in% c("Unknown", "Not reported"), NA, description))

body_typ <- read.csv("body_typ.csv")
body_typ <- body_typ %>% 
  mutate(description = if_else(description %in% c("Unknown body type", "Not Reported"), NA, description))

col_names <- read.csv("column_name_description.csv")

inj_sev <- read.csv("inj_sev.csv")
inj_sev <- inj_sev %>% 
  mutate(description = if_else(description %in% c("Unknown/Not Reported", "N/A"), NA, description))

man_coll <- read.csv("man_coll.csv")
man_coll <- man_coll %>% 
  mutate(description = if_else(description %in% c("Not Reported", "Unknown"), NA, description))

sex <- read.csv("sex.csv")
sex <- sex %>% 
  mutate(description = if_else(description %in% c("not reported", "unknown"), NA, description))

state_code <- read.csv("state_code.csv")
```
# remember to remove setwd

``` {r Data Manipulation}
col_names <- setNames(col_names$column_name, col_names$description)
names(col_names) <- gsub(" ", "_", names(col_names))

Names_Changed <- Accidents_Original %>%
  rename(alcohol = drinking) %>% 
  left_join(state_code, by = c("state" = "state_code")) %>%
  left_join(sex, by = "sex") %>%
  left_join(man_coll, by = "man_coll") %>%
  left_join(inj_sev, by = "inj_sev") %>%
  left_join(body_typ, by = "body_typ") %>%
  left_join(alcohol, by = "alcohol") %>%
    mutate(across(c(year, month, day, hour, minute, age), ~replace(., . == 99, NA)),
         across(c(age), ~replace(., . == 999, NA))) %>%
  drop_na(c("year", "month", "day", "hour", "minute")) %>% 
  mutate(
    state = as.character(state_name),
    sex = as.character(description.x),
    man_coll = as.character(description.y),
    alcohol = as.character(description),
    inj_sev = as.character(description.x.x),
    body_typ = as.character(description.y.y),
    Datetime = ymd_hm(paste(year, month, day, hour, minute)),
    Month_Name = month(month, label = TRUE)
  ) %>%
  rename(!!!col_names) %>% 
  mutate(
    State = as.factor(State),
    County = as.factor(County),
    Manner_of_collision = as.factor(Manner_of_collision),
    Vehicle_body_type = as.factor(Vehicle_body_type),
    Sex = as.factor(Sex),
    Injury_severity = factor(Injury_severity, levels = c("No Apparent Injury", "Injured, Severity Unknown", "Possible Injury", "Suspected Minor Injury", "Suspected Serious Injury", "Non-incapacitating injury", "Fatal Injury", "Died Prior to Crash")),
    Injury_Severity_Basic = if_else(Injury_severity %in% c("Fatal Injury", "Died Prior to Crash"), "Fatal", "Non-Fatal"),
    Datetime = as.POSIXct(Datetime),
    Date = as.Date(Datetime),
    Accident_weekday = factor(wday(Datetime, label = TRUE), levels = c("Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat")),
    Year = year(Datetime)
    ) %>%
  filter(Age < 100) %>% 
  select(-State, -description.x, -description.y, -description.x.x, -description.y.y,-description) %>% 
  mutate(region = case_when(
  state_name == "District of Columbia" ~ "South",
  state.region[match(state_name, state.name)] == "North Central" ~ "Midwest",
  TRUE ~ state.region[match(state_name, state.name)]
)) %>%
  mutate(Vehicle_body_type = case_when(
    grepl("sedan|coupe|convertible|hatchback|automobile|compact", Vehicle_body_type, ignore.case = TRUE) ~ "Automobiles",
    grepl("motorcycle|scooter|moped", Vehicle_body_type, ignore.case = TRUE) ~ "Motorcycles and Scooters",
    grepl("van|minivan", Vehicle_body_type, ignore.case = TRUE) ~ "Vans and Minivans",
    grepl("pickup|utility|truck", Vehicle_body_type, ignore.case = TRUE) ~ "Trucks",
    grepl("bus", Vehicle_body_type, ignore.case = TRUE) ~ "Buses",
    grepl("ATV|snowmobile|golf cart|off-highway", Vehicle_body_type, ignore.case = TRUE) ~ "Specialized Vehicles",
    TRUE ~ "Unknown/Other Vehicle Types"
  )) %>% 
  mutate(Injury_severity = factor(Injury_severity, levels = c("No Apparent Injury", "Possible Injury", "Suspected Minor Injury", "Suspected Serious Injury", "Fatal Injury", "Injured, Severity Unknown", "Died Prior to Crash"), ordered = TRUE))

rm("sex", "alcohol","state_code","man_coll","inj_sev","body_typ")




# https://www.cdc.gov/nchs/hus/sources-definitions/geographic-region.htm

```

# Temporal Analysis 


### Moving window correlation between Number_of_persons_involved and Number_of_vehicles_involved
``` {r Moving Window Statistics, message=FALSE}

SingleWindow <- function(statistic, data, colname = NULL) {
  if (!is.data.frame(data)) {
    stop("The input data must be a dataframe.")
  }
  switch(statistic,
         "correlation" = list(Value = cor(data[,2], data[,3]), Midpoint = data[ceiling(nrow(data)/2), 1]),
         "p value" = list(Value = cor.test(data[,2], data[,3])$p.value, Midpoint = data[ceiling(nrow(data)/2), 1]),
         "OLS" = list(Value = summary(lm(data[,3] ~ data[,2]))$coefficients, Midpoint = data[ceiling(nrow(data)/2), 1]),
         "mean" = list(Value = mean(data[[colname]]), Midpoint = data[ceiling(nrow(data)/2), 1]), # Second column only
         stop("The input statistic must be one of 'correlation', 'p value', 'mean', or 'OLS'.")
  )
}


MovingWindow <- function(data, posix_col, col1, col2, window_days, step_size, statistic) {
  # Ensure the input POSIX column is in POSIXct format
  data[[posix_col]] <- as.POSIXct(data[[posix_col]])
  
  # Calculate the minimum and maximum POSIX values in the dataset
  min_date <- min(data[[posix_col]])
  max_date <- max(data[[posix_col]])
  
  # Convert window_days and step_size to seconds
  window_seconds <- window_days * 24 * 60 * 60
  step_seconds <- step_size * 24 * 60 * 60
  
  # Set the starting date for the moving window
  current_date <- min_date
  
  results = list()
  # Iterate through the dataset using the moving window
  while (current_date + window_seconds <= max_date) {
    # Filter the data within the moving window
    window_data <- data[data[[posix_col]] >= current_date & data[[posix_col]] <= current_date + window_seconds, c(posix_col, col1, col2)]
    
    # Select the posix_col, col1, and col2 using dplyr and set it equal to win_val
    win_val <- window_data %>%
      select(all_of(c(posix_col, col1, col2)))
    
    # Print the win_val dataframe for the current window
    # print(colnames(win_val))
    
    
    if (statistic != "mean") {
      result <- SingleWindow(statistic, win_val)
    }
    if (statistic == "mean") {
      result <- SingleWindow(statistic, win_val, colname = col1)
    }
    
    results <- rbind(results, data.frame(DateTime = current_date,
                                         Value = result$Value[1],
                                         Midpoint = as.POSIXct(result$Midpoint$Datetime)))
    
    # Move the window by step_size
    current_date <- current_date + step_seconds
    
  }
  
  # print(results)
  ggplot(data = results, aes(x=Midpoint,Value))+
    geom_point()
  return(results)
}

# MovingWindow(Names_Changed, "Datetime", "Number_of_persons_involved", "Number_of_vehicles_involved", 30, 15, "correlation")

DayMeanFind <- Names_Changed %>%
  group_by(Datetime) %>%
  summarize(rows_on_date = n()) %>%
  filter(!is.na(rows_on_date))%>%
  mutate(rows_on_date = as.numeric(rows_on_date))

MW_Num_Per_Day <- MovingWindow(DayMeanFind, "Datetime", "rows_on_date", "rows_on_date", 60, 15, "mean")
ggplot(data = MW_Num_Per_Day, aes(x=Midpoint,Value))+
    geom_point() +
  labs(
    title = "Mean Accidents Per Day in 60 Day Window With 15 Day Overlap",
    x = "Date",
    y = "Mean Number of Accidents Per Day"
  ) +
  geom_smooth(method = "loess")

rm("MW_Num_Per_Day","DayMeanFind")
```


``` {r Region Analysis Daily, message=FALSE}

# filter by region and calculate daily mean
south <- Names_Changed %>% 
  filter(region == "South") %>% 
  group_by(Datetime) %>% 
  summarize(rows_on_date = n()) %>% 
  filter(!is.na(rows_on_date)) %>% 
  mutate(rows_on_date = as.numeric(rows_on_date))
southMW <- MovingWindow(south, "Datetime", "rows_on_date", "rows_on_date", 60, 15, "mean")

west <- Names_Changed %>% 
  filter(region == "West") %>% 
  group_by(Datetime) %>% 
  summarize(rows_on_date = n()) %>% 
  filter(!is.na(rows_on_date)) %>% 
  mutate(rows_on_date = as.numeric(rows_on_date))
westMW <- MovingWindow(west, "Datetime", "rows_on_date", "rows_on_date", 60, 15, "mean")

northeast <- Names_Changed %>% 
  filter(region == "Northeast") %>% 
  group_by(Datetime) %>% 
  summarize(rows_on_date = n()) %>% 
  filter(!is.na(rows_on_date)) %>% 
  mutate(rows_on_date = as.numeric(rows_on_date))
northeastMW <- MovingWindow(northeast, "Datetime", "rows_on_date", "rows_on_date", 60, 15, "mean")

midwest <- Names_Changed %>%
  filter(region == "Midwest") %>% 
  group_by(Datetime) %>% 
  summarize(rows_on_date = n()) %>% 
  filter(!is.na(rows_on_date)) %>% 
  mutate(rows_on_date = as.numeric(rows_on_date))
midwestMW <- MovingWindow(midwest, "Datetime", "rows_on_date", "rows_on_date", 60, 15, "mean")

set.seed(123)
AllRegionsLong <- bind_rows(
  southMW %>% mutate(region = "South") %>% slice_sample(n = 25000, replace = FALSE),
  westMW %>% mutate(region = "West") %>% slice_sample(n = 25000, replace = FALSE),
  northeastMW %>% mutate(region = "Northeast") %>% slice_sample(n = 25000, replace = FALSE),
  midwestMW %>% mutate(region = "Midwest") %>% slice_sample(n = 25000, replace = FALSE) 
)

ggplot(data = AllRegionsLong, aes(x=Midpoint,y=Value, col = region))+
  # geom_point(alpha = 1/4) +
  labs(
    title = "Mean Accidents (loess) Per Day in 60 Day Window With 15 Day Overlap By Region",
    x = "Date",
    y = "Mean Number of Accidents Per Day",
    caption = "To reduce render time, sample sizes have been capped at 25,000 per region"
  ) +
  scale_x_datetime(date_breaks = "2 years", date_labels = "%Y") +
  geom_smooth(method = "loess", aes(group = region), formula = "y ~ x", se = FALSE, span = 0.6) +
  theme(legend.position = "top",
        panel.grid.major = element_line(color = "gray", linetype = "dashed"),
        panel.grid.minor = element_blank()) +
  guides(col = guide_legend(title.position = "top", nrow = 1))+
  scale_color_discrete(name = "Regions:")

rm("south", "west", "midwest","northeast","southMW", "westMW", "northeastMW", "midwestMW","AllRegionsLong") 

```


### Graph 2: Number of Accidents per Month
```{r Graph 2: Number of Accidents per Month}
APM <- ggplot(Names_Changed %>% filter(!is.na(Datetime)), aes(x = month(Datetime, label = TRUE))) +
  geom_bar() +
  ggtitle("Number of Accidents per Month") + 
  facet_wrap( ~ region) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(x = "Months", y = "Count")
APMRel <- ggplot(Names_Changed %>% filter(!is.na(Datetime)), aes(x = month(Datetime, label = TRUE))) +
   geom_bar() +
   ggtitle("Number of Accidents per Month") + 
   facet_wrap( ~ region, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(x = "Months", y = "Count")

gridExtra::grid.arrange(APM, APMRel, ncol = 2)
rm("APM","APMRel")
```


### Graph 17: Density of Accidents by Day of Month and Time of Day
```{r Graph 17: Density of Accidents by Day of Month and Time of Day}
ggplot(Names_Changed, aes(x = Accident_hour, y = Accident_day)) +
geom_bin2d(bins = 20) +
labs(x = "Hour of day", y = "Day of month", fill = "Number of accidents", title = "Density of Accidents by Day of Month and Time of Day") +
  scale_y_continuous(breaks = seq(1, 31, by = 1))+
  scale_x_continuous(breaks = seq(0, 24, by = 1)) 

```

# Demographic Analysis

### Graph 5: Distribution of Age of Persons Involved in Accidents
```{r Graph 5: Distribution of Age of Persons Involved in Accidents, message=FALSE}
AgeSexOne <- ggplot(Names_Changed %>% filter(!is.na(Age)) %>% filter(!is.na(Sex)), aes(x = Age, fill = Sex)) +
  geom_bar(stat = "count", position = "stack") +
  labs(y = "Count", title = "Distribution of Age of Persons Involved in Accidents")

SexAgeGraph <- Names_Changed %>% 
  filter(!is.na(Sex)) %>% 
  filter(!is.na(Age)) %>% 
  group_by(Age, Sex) %>% 
  summarise(Count = n()) %>% 
  mutate(Percent = Count/sum(Count)*100)

AgeSexTwo <- ggplot(data = SexAgeGraph, aes(x = Age, y = Percent, fill = Sex)) +
  geom_col(position = "stack") +
  ggtitle("Percent of Each Sex Who Are In Accidents By Age")+
  geom_abline(intercept = 50, slope = 0, alpha = 0.75, linetype = "dashed")

gridExtra::grid.arrange(AgeSexOne, AgeSexTwo)

# New:

LongAlcSexAge <- Names_Changed %>%
  filter(!is.na(Alcohol_involvement)) %>%
  filter(!is.na(Sex)) %>%
  filter(!is.na(Age)) %>%
  mutate(grp = paste0(Sex,Alcohol_involvement)) %>% 
  mutate(grp = factor(paste0(Sex, Alcohol_involvement), 
                      levels = c("femaleNo (Alcohol Not Involved)", 
                                 "maleNo (Alcohol Not Involved)", 
                                 "maleYes (Alcohol Involved)", 
                                 "femaleYes (Alcohol Involved)"))) %>% 
  group_by(Age, grp) %>%
  summarise(Accident_count = n()) %>% 
  mutate(perc = Accident_count / sum(Accident_count) * 100) %>%
  mutate(grp = fct_recode(grp,
                          "Female, No Alcohol" = "femaleNo (Alcohol Not Involved)",
                          "Male, No Alcohol" = "maleNo (Alcohol Not Involved)",
                          "Male, Alcohol Involved" = "maleYes (Alcohol Involved)",
                          "Female, Alcohol Involved" = "femaleYes (Alcohol Involved)"))


AgeSexAlcOne <- ggplot(Names_Changed %>% filter(!is.na(Sex)) %>% filter(!is.na(Alcohol_involvement)) %>% filter(!is.na(Age)), aes(x = Age, fill =  paste0(Sex,Alcohol_involvement))) +
  geom_bar(stat = "count", position = "stack")

AgeSexAlcTwo <- ggplot(LongAlcSexAge, aes(x = Age, y = perc, fill = grp)) +
  geom_col(position = "stack") +
  scale_fill_manual(values = c("coral1", "dodgerblue1", "dodgerblue4", "coral4")) +
  labs(title = "Percent of Accidents by Age, Sex, and Intoxication Level",
       x = "Age",
       y = "Number of Accidents",
       fill = "Group") +
  theme_minimal()

gridExtra::grid.arrange(AgeSexAlcOne, AgeSexAlcTwo)

```


### Graph 6: Number of Accidents by Sex
```{r Graph 6: Number of Accidents by Sex}
ggplot(Names_Changed %>% filter(!is.na(Sex)), aes(x = Sex, fill = Injury_Severity_Basic)) +
geom_bar() +
ggtitle("Number of Accidents by Sex")
```

### Graph 22: Distribution of Age by Sex Involved in Accidents
```{r Graph 22: Distribution of Age by Sex Involved in Accidents}
ggplot(Names_Changed, aes(x = Sex, y = Age)) +
geom_boxplot() +
labs(x = "Sex", y = "Age", title = "Distribution of Age by Sex Involved in Accidents")
```

### Graph 34: Density plot of Age - Is this needed or redundant?
```{r Plot34, fig.cap="Density plot showing the distribution of age of individuals involved in accidents."}
ggplot(data = Names_Changed, aes(x = Age)) +
  geom_density(fill = "lightblue", alpha = 0.6) +
  theme_minimal() +
  labs(x = "Age", y = "Density")

```

### Graph 36: Violin plot of Age by Sex
```{r Plot36, fig.cap="Violin plot showing the distribution of age of individuals involved in accidents, separated by sex."}
ggplot(data = Names_Changed, aes(x = Sex, y = Age, fill = Sex)) +
  geom_violin() +
  theme_minimal() +
  labs(x = "Sex", y = "Age")+
  theme_minimal()
```
### Graph 35: Age vs Number of Persons Involved by Sex
```{r Plot35, fig.cap="Scatter plot showing the relationship between age and number of persons involved in accidents, separated by sex."}
ggplot(data = Names_Changed, aes(x = Age, y = Number_of_persons_involved)) +
  geom_hex() +
  facet_wrap(~ Sex) +
  theme_minimal() +
  labs(x = "Age", y = "Number of Persons Involved")

```

### Graph 44: Boxplot of Age by Injury Severity
``` {r Graph 44, fig.cap="Boxplot of Age by Injury Severity"}
ggplot(Names_Changed, aes(x = Injury_severity, y = Age)) +
  geom_boxplot() +
  labs(title = "Boxplot of Age by Injury Severity", x = "Injury Severity", y = "Age") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

### Graph 25: Distribution of Age by Manner of Collision
```{r Graph 25: Distribution of Age by Manner of Collision}
ggplot(Names_Changed, aes(x = Manner_of_collision, y = Age)) +
geom_boxplot() +
labs(x = "Manner of collision", y = "Age", title = "Distribution of Age by Manner of Collision") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

### Graph 45: Normality: Q-Q plot of Age
``` {r Graph 45, Normality: Q-Q plot of Age}
ggplot(Names_Changed, aes(sample = Age)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  labs(title = "Q-Q Plot of Age", x = "Theoretical Quantiles", y = "Sample Quantiles") +
  theme_minimal()
```


# Accident Characteristics

### Graph 28: Relationship between Hour of Day and Age of Persons Involved in Accidents, Colored by Injury Severity and Faceted by Sex - Make hex plot? Even possible to do so? Otherwise it is fine
```{r Graph 28: Relationship between Hour of Day and Age of Persons Involved in Accidents, Colored by Injury Severity and Faceted by Sex}
ggplot(Names_Changed %>% filter(!is.na(Sex)), aes(x = Accident_hour, y = Age, color = Injury_Severity_Basic)) +
  geom_point(alpha = 0.002) +
  facet_wrap(~ Vehicle_body_type) +
  labs(x = "Hour of day", y = "Age", color = "Injury severity", title = "Relationship between Hour of Day and Age of Persons Involved in Accidents, Colored by Injury Severity and Faceted by Sex")+
  guides(color = guide_legend(override.aes = list(alpha = 1)))
```

### Graph 29: Visualizing the Frequency of Accidents Throughout the Year
```{r Graph 29: Visualizing the Frequency of Accidents Throughout the Year, message=FALSE}
accidents_per_day <- Names_Changed %>%
mutate(DoY = yday(Datetime), Month = month(Datetime), Day = day(Datetime), Hour = hour(Datetime)) %>%
group_by(Month, Day, Hour) %>%
summarize(count = n()) %>%
ungroup()

ggplot(accidents_per_day, aes(x = Day, y = Month, fill = count)) +
geom_tile(color = "white") +
scale_y_continuous(trans = 'reverse', breaks = 1:12, labels = month.abb) +
labs(x = "Day", y = "Month", fill = "Accidents", title = "Visualizing the Frequency of Accidents Throughout the Year") +
theme_minimal() 
```


### Graph 12: Age Distribution by Injury Severity
```{r Graph 12: Age Distribution by Injury Severity}
ggplot(Names_Changed, aes(x = Injury_severity, y = Age)) +
geom_boxplot() +
labs(x = "Injury Severity", y = "Age", title = "Age Distribution by Injury Severity") +
theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

### Graph 20: Relationship between Age and Time of Day When Accidents Occur - why 24 and 0 different? FIX THIS
```{r Graph 20: Relationship between Age and Time of Day When Accidents Occur}
# ggplot(Names_Changed, aes(x = Accident_hour, y = Age)) +
# geom_point(alpha = 0.003) +
# labs(x = "Hour of day", y = "Age", title = "Relationship between Age and Time of Day When Accidents Occur")
ggplot(Names_Changed, aes(x = Accident_hour, y = Age)) +
  geom_point(alpha = 0.003) +
  labs(x = "Hour of day", y = "Age", title = "Relationship between Age and Time of Day When Accidents Occur") +
  scale_alpha(trans = "log", range = c(0.005, 0.5))+
  theme_minimal()

```

### Graph 21: Number of Accidents by Vehicle Body Type and Injury Severity
```{r Graph 21: Number of Accidents by Vehicle Body Type and Injury Severity}

ggplot(Names_Changed, aes(y = Vehicle_body_type, fill = Injury_severity)) +
    geom_bar(position = "stack") +
    labs(x = "Vehicle body type", y = "Number of accidents", title = "Number of Accidents by Vehicle Body Type and Injury Severity")+
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    scale_fill_manual(values = c("lightblue", "orange", "mediumpurple1", "red1", "darkred", "tan1", "indianred3"))+
    theme_minimal()+
    theme(legend.position = "bottom", # Move legend to bottom
          legend.title = element_blank()) 



Names_Changed_Injury <- Names_Changed %>%
  filter(Age < 18, !is.na(Sex)) %>%
  group_by(Manner_of_collision, Injury_Severity_Basic, Sex) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  mutate(Manner_of_collision = fct_reorder(Manner_of_collision, -count, .fun = mean)) 

ggplot(data = Names_Changed_Injury, 
       aes(x = Manner_of_collision, y = count, fill = Sex)) +
  geom_col(position = "dodge") +
  ylab("Count of Injury_Severity_Basic") +
  guides(fill = guide_legend(override.aes = list(alpha = 1))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
  theme_minimal()+
  scale_fill_manual(values = c("indianred3","lightblue"))
rm("Names_Changed_Injury")
```

### Graph 23: Number of Accidents by Month and Injury Severity
```{r Graph 23: Number of Accidents by Month and Injury Severity}
ggplot(Names_Changed %>% filter(!is.na(Injury_severity)), aes(x = Month_Name, fill = Injury_severity)) +
  geom_bar() +
  labs(x = "Month", y = "Number of accidents", title = "Number of Accidents by Month and Injury Severity") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_manual(values = c("lightblue", "orange", "mediumpurple1", "red1", "darkred", "tan1", "indianred3"))+
  theme_minimal()
```


### Graph 26: Heatmap of Accidents by Hour and Day of the Week
```{r Graph 26: Heatmap of Accidents by Hour and Day of the Week, message=FALSE}
accidents_by_hour_weekday <- Names_Changed %>%
group_by(hour = hour(Datetime), weekday = wday(Datetime, label = TRUE)) %>%
summarize(n = n())

ggplot(accidents_by_hour_weekday, aes(x = hour, y = weekday, fill = n)) +
geom_tile() +
scale_fill_gradient(low = "#f7f7f7", high = "#e31a1c") +
labs(x = "Hour of day", y = "Day of week", fill = "Number of accidents", title = "Heatmap of Accidents by Hour and Day of the Week")+
  theme_minimal()
```


### Graph 30: Analyzing the Relationship Between Time and Accidents Across Different Months - I should find what state is most dangerous for July 4th and New Years, Also view just Feb to see what is going on with the line
Note: February 29th removed to account for leap years 
```{r Graph 30: Analyzing the Relationship Between Time and Accidents Across Different Months, message=FALSE}
accidents_per_day <- Names_Changed %>%
mutate(DoY = yday(Datetime), Month = month(Datetime), Day = day(Datetime), Hour = hour(Datetime)) %>%
group_by(Month, Day, Hour) %>%
summarize(count = n()) %>%
ungroup()

ggplot(subset(accidents_per_day, !(Month == 2 & Day == 29)), aes(x = Day, y = Hour, fill = count - mean(count))) +
  geom_tile(width = 0.5) +
  scale_y_reverse() +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
  facet_wrap(~ month(Month, label = TRUE)) +
  labs(x = "Day", y = "Time", fill = "Accidents", title = "Analyzing the Relationship Between Time and Accidents Across Different Months")+
  theme_minimal()

```

### Graph 32: Time-based analysis - Seasonal decomposition plot
```{r Plot32, fig.cap="Seasonal decomposition plot showing the trend of accidents over time, highlighting any seasonality in the data.", message=FALSE}
daily_accidents <- Names_Changed %>%
  group_by(Date) %>%
  summarise(accidents_per_day = n())
accidents_ts <- ts(daily_accidents$accidents_per_day, start = c(1996, 1, 1), frequency = 365)
accidents_decomposed <- stats::decompose(accidents_ts, type = "additive")
decomposed_df <- data.frame(
  Date = daily_accidents$Date,
  Observed = accidents_decomposed$x,
  Trend = accidents_decomposed$trend,
  Seasonal = accidents_decomposed$seasonal,
  Random = accidents_decomposed$random
) %>%
  gather(key = "Component", value = "Value", -Date)



ggplot(decomposed_df, aes(x = Date, y = Value)) +
  geom_line() +
  facet_wrap(~ Component, ncol = 1, scales = "free_y") +
  labs(
    title = "Seasonal Decomposition Plot",
    x = "Date",
    y = "Number of Accidents"
  ) +
  theme_minimal()


ggplot(decomposed_df %>% filter(Component == "Seasonal"), aes(x = Date, y = Value)) +
  geom_line() +
  labs(
    title = "Seasonal Component",
    x = "Date",
    y = "Seasonal Effect"
  ) +
  theme_minimal()

# decomposed_df$Year <- year(decomposed_df$Date)
# decomposed_seasonal <- decomposed_df %>%
#   filter(Year >= 2010, Year < 2016)
#   
#   
# ggplot(decomposed_seasonal, aes(x = Date, y = Value)) +
#   geom_line() +
#   labs(
#     title = "Seasonal Component",
#     x = "Date",
#     y = "Seasonal Effect"
#   ) +
#   facet_wrap(~ Year, ncol = 1, scales = "free_x") +
#   theme_minimal()

```



### Graph 37: Hexbin plot of Age vs Number of Persons Involved
```{r Plot37, fig.cap="Hexbin plot showing the density of points in a hexagonal grid, with the x-axis representing age and y-axis representing the number of persons involved in accidents."}
ggplot(data = Names_Changed, aes(x = Age, y = Number_of_persons_involved)) +
  geom_hex(bins = 30) +
  theme_minimal() +
  labs(x = "Age", y = "Number of Persons Involved")
```

### Graph 38: Density plot of Age distribution by Injury Severity
```{r Plot38, fig.cap="Ridge plot showing the distribution of age of individuals involved in accidents, separated by injury severity."}

ggplot(data = Names_Changed, aes(x = Age, fill = Injury_severity)) +
  geom_density(alpha = 0.6) +
  scale_fill_manual(values = c("lightblue", "orange", "mediumpurple1", "red1", "darkred", "tan1", "indianred4")) +
  labs(x = "Age", y = "Density") +
  theme_minimal() +
  facet_wrap(~ Injury_severity, scales = "free") +
  xlim(0, 100) +
  guides(fill = "none")


```


# Do teens have more accidents on weekends? (Subset data or mutate a column identifying weekends and facet)
``` {r Teens}
library(ggplot2)

# Filter the data to only include accidents involving teens (ages 16-19)
teens <- Names_Changed %>% filter(Age >= 16 & Age <= 19)

# Plot 1: Number of accidents by day of the week for teens
P1Teen <- ggplot(teens %>% filter(!is.na(Alcohol_involvement)), aes(x = Accident_weekday, fill = Alcohol_involvement)) +
  geom_bar() +
  labs(title = "Number of accidents by day of the week for teens",
       x = "Day of the week",
       y = "Number of accidents") +
  facet_wrap( ~ region)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  guides(fill = FALSE)+
  theme_minimal()

# Plot 2: Proportion of alcohol involvement by day of the week for teens
P2Teen <- ggplot(teens %>% filter(!is.na(Alcohol_involvement)), aes(x = Accident_weekday , fill = Alcohol_involvement)) +
  geom_bar(position = "fill") +
  labs(title = "Proportion of alcohol involvement by day of the week for teens",
       x = "Day of the week",
       y = "Proportion of accidents") +
  facet_wrap( ~ region)+
  theme(legend.position = "bottom", # Move legend to bottom
        legend.title = element_blank()) + # Adjust size of legend key
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  theme_minimal()

gridExtra::grid.arrange(P1Teen, P2Teen, ncol = 2, widths = c(3, 4))

```

# What leads to fatal accidents? (Subset data or mutate a column identifying fatal and facet)



# Maybe look at deaths of children and where the collisions take place, like are sideswipes more dangerous cause theyre in the back seat?



``` {r QQ Plots}

ggplot(Names_Changed, aes(sample = Age)) +
  geom_qq() +
  geom_qq_line(color = "red")

ggplot(Names_Changed, aes(sample = Number_of_persons_involved)) +
  geom_qq() +
  geom_qq_line(color = "red")

ggplot(Names_Changed, aes(sample = Number_of_vehicles_involved)) +
  geom_qq() +
  geom_qq_line(color = "red")

ggplot(Names_Changed, aes(sample = Accident_hour)) +
  geom_qq() +
  geom_qq_line(color = "red")

ggplot(Names_Changed, aes(sample = Accident_day)) +
  geom_qq() +
  geom_qq_line(color = "red")



```

