---
title: "Temporal Analysis of Vehicle Accident Data"
subtitle: "A Data-Driven Approach"
author: "William Kopans"
date: "`r Sys.Date()`"
output: powerpoint_presentation
---

```{r setup, include=FALSE}
library(here)
knitr::opts_chunk$set(warning = FALSE, 
                      message = FALSE,
                      echo = FALSE,
                      cache = TRUE,
                      cache.path = here::here(".cache"),
                      cache.size = 1500,
                      cache.lazy = TRUE,
                      cache.rebuild = TRUE,
                      cache.extra = list(png = here::here("images/"), pdf = here::here("documents/")))
```

``` {r Import Dataset and libraries, message=FALSE}
library(ggplot2)
library(tidyverse)
library(lubridate)

set.seed(123)

PackagesToCheck <- list( "ggplot2", "tidyverse", "lubridate")

for (i in PackagesToCheck) {
  if (i %in% rownames(installed.packages()) == FALSE) {
    install.packages(i)
  }
}

Accidents_Original <- readRDS("farsp.RDS")

alcohol <- read.csv("alcohol.csv")
alcohol <- alcohol %>% 
  mutate(description = if_else(description %in% c("Unknown", "Not reported"), NA, description))

body_typ <- read.csv("body_typ.csv")
body_typ <- body_typ %>% 
  mutate(description = if_else(description %in% c("Unknown body type", "Not Reported"), NA, description))

col_names <- read.csv("column_name_description.csv")

inj_sev <- read.csv("inj_sev.csv")
inj_sev <- inj_sev %>% 
  mutate(description = if_else(description %in% c("Unknown/Not Reported", "N/A"), NA, description))

man_coll <- read.csv("man_coll.csv")
man_coll <- man_coll %>% 
  mutate(description = if_else(description %in% c("Not Reported", "Unknown"), NA, description))

sex <- read.csv("sex.csv")
sex <- sex %>% 
  mutate(description = if_else(description %in% c("not reported", "unknown"), NA, description))

state_code <- read.csv("state_code.csv")
```


``` {r Data Manipulation}
col_names <- setNames(col_names$column_name, col_names$description)
names(col_names) <- gsub(" ", "_", names(col_names))

Master_Dataframe <- Accidents_Original %>%
  rename(alcohol = drinking) %>% 
  left_join(state_code, by = c("state" = "state_code")) %>%
  left_join(sex, by = "sex") %>%
  left_join(man_coll, by = "man_coll") %>%
  left_join(inj_sev, by = "inj_sev") %>%
  left_join(body_typ, by = "body_typ") %>%
  left_join(alcohol, by = "alcohol") %>%
    mutate(across(c(year, month, day, hour, minute, age), ~replace(., . == 99, NA)),
         across(c(age), ~replace(., . == 999, NA))) %>%
  drop_na(c("year", "month", "day", "hour", "minute")) %>% 
  mutate(
    state = as.character(state_name),
    sex = as.character(description.x),
    man_coll = as.character(description.y),
    alcohol = as.character(description),
    inj_sev = as.character(description.x.x),
    body_typ = as.character(description.y.y),
    Datetime = ymd_hm(paste(year, month, day, hour, minute)),
    Month_Name = month(month, label = TRUE)
  ) %>%
  rename(!!!col_names) %>% 
  mutate(
    State = as.factor(State),
    County = as.factor(County),
    Manner_of_collision = as.factor(Manner_of_collision),
    Vehicle_body_type = as.factor(Vehicle_body_type),
    Sex = as.factor(Sex),
    Injury_severity = factor(Injury_severity, levels = c("No Apparent Injury", "Injured, Severity Unknown", "Possible Injury", "Suspected Minor Injury", "Suspected Serious Injury", "Non-incapacitating injury", "Fatal Injury", "Died Prior to Crash")),
    Injury_Severity_Basic = if_else(Injury_severity %in% c("Fatal Injury", "Died Prior to Crash"), "Fatal", "Non-Fatal"),
    Datetime = as.POSIXct(Datetime),
    Date = as.Date(Datetime),
    Accident_weekday = factor(wday(Datetime, label = TRUE), levels = c("Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat")),
    Year = year(Datetime)
    ) %>%
  filter(Age < 100) %>% 
  select(-State, -description.x, -description.y, -description.x.x, -description.y.y,-description) %>% 
  mutate(region = case_when(
  state_name == "District of Columbia" ~ "South",
  state.region[match(state_name, state.name)] == "North Central" ~ "Midwest",
  TRUE ~ state.region[match(state_name, state.name)]
),
Vehicle_body_type = case_when(
    grepl("sedan|coupe|convertible|hatchback|automobile|compact", Vehicle_body_type, ignore.case = TRUE) ~ "Automobiles",
    grepl("motorcycle|scooter|moped", Vehicle_body_type, ignore.case = TRUE) ~ "Motorcycles and Scooters",
    grepl("van|minivan", Vehicle_body_type, ignore.case = TRUE) ~ "Vans and Minivans",
    grepl("pickup|utility|truck", Vehicle_body_type, ignore.case = TRUE) ~ "Trucks",
    grepl("bus", Vehicle_body_type, ignore.case = TRUE) ~ "Buses",
    grepl("ATV|snowmobile|golf cart|off-highway", Vehicle_body_type, ignore.case = TRUE) ~ "Specialized Vehicles",
    TRUE ~ "Unknown/Other Vehicle Types"
  ),
  Injury_severity = factor(Injury_severity, levels = c("No Apparent Injury", "Possible Injury", "Suspected Minor Injury", "Suspected Serious Injury", "Fatal Injury", "Injured, Severity Unknown", "Died Prior to Crash"), ordered = TRUE),
         time_period = case_when(
            Accident_hour >= 5 & Accident_hour < 12 ~ "morning",
            Accident_hour >= 12 & Accident_hour < 17 ~ "midday",
            Accident_hour >= 17 & Accident_hour < 20 ~ "evening",
            Accident_hour >= 20 & Accident_hour < 24 ~ "night",
            Accident_hour >= 0 & Accident_hour < 5 ~ "late_night",
            TRUE ~ "unknown"
  ))

rm("sex", "alcohol","state_code","man_coll","inj_sev","body_typ")




# https://www.cdc.gov/nchs/hus/sources-definitions/geographic-region.htm

```

# Introduction:

* Driving is one of the most dangerous activities we engage in daily, causing `r library(dplyr); format(round(nrow(Master_Dataframe %>% filter(Injury_Severity_Basic == "Fatal")) / (max(Master_Dataframe$Accident_year)-min(Master_Dataframe$Accident_year)), digits = -3), scientific = FALSE, big.mark=",")` deaths annually.
* Understanding root causes of accidents can improve road infrastructure, inform policy decisions, and educate drivers.
* By analyzing this data using temporal analysis, we can identify ways to reduce the risk of injury or death.
* Although driving will always be inherently risky, data-driven insights can help us minimize that risk.


# Data Collection and Preparation:

* Data Source: U.S. Department of Transportation’s National Highway Traffic Safety Administration
* Time Period: `r min(Master_Dataframe$Accident_year)` - `r max(Master_Dataframe$Accident_year)`
* Dataset Size: `r format(nrow(Master_Dataframe), big.mark=",")` accidents recorded
* Information Captured: Date/time, intoxication, injury severity, location, etc.
* Data Cleaning and Manipulation Steps:
    + Column/Row names modified for readability
    + Data cleaned and transformed using dplyr
    + Additional columns added for region and accident timing

# Number of Accidents by Month and Injury Severity:

* Accident statistics by month:
  + Most accidents occur in July
  + Fewest accidents occur in February
* Fatalities statistics by month:
  + Not as much of a drop in February as compared to July despite fewer accidents
  + Around `r Master_Dataframe %>% filter(Injury_Severity_Basic == "Fatal") %>%  group_by(Accident_month) %>% summarize(count = n()) %>% summarize(mean_count = mean(count)) %>% pull(mean_count) %>% round(digits = -3) %>% format(big.mark = ",")` deaths per year, fairly constant throughout the year
  + Elevated during summer months for fatal injuries
* Injury statistics by month:
  + Peak of suspected major and minor injuries in July
  + Confirmed injuries do not show the same peak
* Non-injury accidents:
  + Fairly steady across all months
  + Around `r Master_Dataframe %>% filter(Injury_severity == "No Apparent Injury") %>%  group_by(Accident_month) %>% summarize(count = n()) %>% summarize(mean_count = mean(count)) %>% pull(mean_count) %>% round(digits = -3) %>% format(big.mark = ",")` incidents per month


```{r Graph 1: Number of Accidents by Month and Injury Severity, fig.width = 12}
ggplot(Master_Dataframe %>% filter(!is.na(Injury_severity)), aes(x = Month_Name, fill = Injury_severity)) +
  geom_bar() +
  labs(x = "Month", y = "Number of accidents", title = "Number of Accidents by Month and Injury Severity") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_manual(values = c("lightblue", "orange", "mediumpurple1", "red1", "darkred", "tan1", "indianred3"))+
  theme_minimal()
```



# Number of Accidents per Month

* Majority of accidents occur in the south region
* Northeast region has the least accidents
* Midwest, northeast, and west regions show a normal distribution of accidents centered around August when adjusting non-uniform scales
* South region shows similar accident levels across months

```{r Graph 2: Number of Accidents per Month, fig.width = 12}
APM <- ggplot(Master_Dataframe %>% filter(!is.na(Datetime)), aes(x = month(Datetime, label = TRUE))) +
  geom_bar() +
  ggtitle("Number of Accidents per Month") + 
  facet_wrap( ~ region) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(x = "Months", y = "Count")
APMRel <- ggplot(Master_Dataframe %>% filter(!is.na(Datetime)), aes(x = month(Datetime, label = TRUE))) +
   geom_bar() +
   ggtitle("Number of Accidents per Month") + 
   facet_wrap( ~ region, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(x = "Months", y = "Count")

gridExtra::grid.arrange(APM, APMRel, ncol = 2)
rm("APM","APMRel")
```


# Analyzing the Relationship Between Time and Accidents Across Different Months 
Note: February 29th removed to account for leap years 

* New Year's and July 4th are dangerous times to be on the road
* After 4pm on July 4th and just after midnight on January 1st are especially dangerous
* Mornings are reasonably safe
* Accidents pick up around 9:00 am
* Accidents become much more frequent after 4:00 pm



```{r Graph 3: Analyzing the Relationship Between Time and Accidents Across Different Months, message=FALSE}
accidents_per_day <- Master_Dataframe %>%
mutate(DoY = yday(Datetime), Month = month(Datetime), Day = day(Datetime), Hour = hour(Datetime)) %>%
group_by(Month, Day, Hour) %>%
summarize(count = n()) %>%
ungroup()

ggplot(subset(accidents_per_day, !(Month == 2 & Day == 29)), aes(x = Day, y = Hour, fill = count - mean(count))) +
  geom_tile(width = 0.5) +
  scale_y_reverse() +
  scale_fill_gradient2(low = "dodgerblue4", mid = "white", high = "indianred3", midpoint = 0) +
  facet_wrap(~ month(Month, label = TRUE)) +
  labs(x = "Day", y = "Time", fill = "Accidents", title = "Analyzing the Relationship Between Time and Accidents Across Different Months")+
  theme_minimal()

```


# Heatmap of Accidents by Hour and Day of the Week

* Weekdays: Few accidents before 5:00 am
* Weekdays: Uptick when going to (8am) and leaving (3-6pm) work
* Friday and Saturday: Night through early-morning of next day are dangerous
* Weekends: Safe before noon and more dangerous through night

```{r Graph 4: Heatmap of Accidents by Hour and Day of the Week, message=FALSE}
accidents_by_hour_weekday <- Master_Dataframe %>%
group_by(hour = hour(Datetime), weekday = wday(Datetime, label = TRUE)) %>%
summarize(n = n())

ggplot(accidents_by_hour_weekday, aes(x = hour, y = weekday, fill = n)) +
geom_tile() +
scale_fill_gradient(low = "#f7f7f7", high = "indianred3") +
labs(x = "Hour of day", y = "Day of week", fill = "Number of accidents", title = "Heatmap of Accidents by Hour and Day of the Week")+
  theme_minimal()
```

# Distribution of Age of Persons Involved in Accidents

* Majority of accidents occur at night (8:00 pm to midnight)
* Fewest accidents occur during the evening (5:00 pm to 8:00 pm)
* Evening window is smallest and distorts accident count
* Fewer people over age 60 get in accidents in the evening
* Men are involved in more accidents than women across the board
* Men involvement in accidents is especially apparent between ages 16 and 75
* During night/twilight hours, proportion of men to women increases among older people
* Male and female involvement in accidents are most balanced during mid-day period.

### Morning
```{r Graph 5: Distribution of Age of Persons Involved in Accidents Morning, message=FALSE}
SexAgeGraph <- Master_Dataframe %>% 
  filter(!is.na(Sex) & !is.na(Age) & time_period == "morning") %>% 
  group_by(Age, Sex) %>% 
  summarise(Count = n()) %>% 
  mutate(Percent = Count/sum(Count)*100)

AgeSexOne <- ggplot(Master_Dataframe %>% filter(!is.na(Age) & !is.na(Sex) & time_period == "morning"),  aes(x = Age, fill = Sex)) +
  geom_bar(stat = "count", position = "stack") +
  labs(y = "Count", title = "Distribution of Age of Persons Involved in Accidents") + ylim(0,15000)

AgeSexTwo <- ggplot(data = SexAgeGraph, aes(x = Age, y = Percent, fill = Sex)) +
  geom_col(position = "stack") +
  ggtitle("Percent of Each Sex Who Are In Accidents By Age")+
  geom_abline(intercept = 50, slope = 0, alpha = 0.75, linetype = "dashed")

gridExtra::grid.arrange(AgeSexOne, AgeSexTwo)
```

# Distribution of Age of Persons Involved in Accidents

* Majority of accidents occur at night (8:00 pm to midnight)
* Fewest accidents occur during the evening (5:00 pm to 8:00 pm)
* Evening window is smallest and distorts accident count
* Fewer people over age 60 get in accidents in the evening
* Men are involved in more accidents than women across the board
* Men involvement in accidents is especially apparent between ages 16 and 75
* During night/twilight hours, proportion of men to women increases among older people
* Male and female involvement in accidents are most balanced during mid-day period.

### Mid-Day
```{r Distribution of Age of Persons Involved in Accidents Midday, message=FALSE}
SexAgeGraph <- Master_Dataframe %>% 
  filter(!is.na(Sex) & !is.na(Age) & time_period == "midday") %>% 
  group_by(Age, Sex) %>% 
  summarise(Count = n()) %>% 
  mutate(Percent = Count/sum(Count)*100)

AgeSexOne <- ggplot(Master_Dataframe %>% filter(!is.na(Age) & !is.na(Sex) & time_period == "midday"),  aes(x = Age, fill = Sex)) +
  geom_bar(stat = "count", position = "stack") +
  labs(y = "Count", title = "Distribution of Age of Persons Involved in Accidents")+ ylim(0,15000)

AgeSexTwo <- ggplot(data = SexAgeGraph, aes(x = Age, y = Percent, fill = Sex)) +
  geom_col(position = "stack") +
  ggtitle("Percent of Each Sex Who Are In Accidents By Age")+
  geom_abline(intercept = 50, slope = 0, alpha = 0.75, linetype = "dashed")

gridExtra::grid.arrange(AgeSexOne, AgeSexTwo)
```

# Distribution of Age of Persons Involved in Accidents

* Majority of accidents occur at night (8:00 pm to midnight)
* Fewest accidents occur during the evening (5:00 pm to 8:00 pm)
* Evening window is smallest and distorts accident count
* Fewer people over age 60 get in accidents in the evening
* Men are involved in more accidents than women across the board
* Men involvement in accidents is especially apparent between ages 16 and 75
* During night/twilight hours, proportion of men to women increases among older people
* Male and female involvement in accidents are most balanced during mid-day period.

### Evening
```{r Distribution of Age of Persons Involved in Accidents Evening, message=FALSE}
SexAgeGraph <- Master_Dataframe %>% 
  filter(!is.na(Sex) & !is.na(Age) & time_period == "evening") %>% 
  group_by(Age, Sex) %>% 
  summarise(Count = n()) %>% 
  mutate(Percent = Count/sum(Count)*100)

AgeSexOne <- ggplot(Master_Dataframe %>% filter(!is.na(Age) & !is.na(Sex) & time_period == "evening"),  aes(x = Age, fill = Sex)) +
  geom_bar(stat = "count", position = "stack") +
  labs(y = "Count", title = "Distribution of Age of Persons Involved in Accidents")+ ylim(0,15000)

AgeSexTwo <- ggplot(data = SexAgeGraph, aes(x = Age, y = Percent, fill = Sex)) +
  geom_col(position = "stack") +
  ggtitle("Percent of Each Sex Who Are In Accidents By Age")+
  geom_abline(intercept = 50, slope = 0, alpha = 0.75, linetype = "dashed")

gridExtra::grid.arrange(AgeSexOne, AgeSexTwo)
```

# Distribution of Age of Persons Involved in Accidents

* Majority of accidents occur at night (8:00 pm to midnight)
* Fewest accidents occur during the evening (5:00 pm to 8:00 pm)
* Evening window is smallest and distorts accident count
* Fewer people over age 60 get in accidents in the evening
* Men are involved in more accidents than women across the board
* Men involvement in accidents is especially apparent between ages 16 and 75
* During night/twilight hours, proportion of men to women increases among older people
* Male and female involvement in accidents are most balanced during mid-day period.

### Night
```{r Distribution of Age of Persons Involved in Accidents Evening Night, message=FALSE}
SexAgeGraph <- Master_Dataframe %>% 
  filter(!is.na(Sex) & !is.na(Age) & time_period == "night") %>% 
  group_by(Age, Sex) %>% 
  summarise(Count = n()) %>% 
  mutate(Percent = Count/sum(Count)*100)

AgeSexOne <- ggplot(Master_Dataframe %>% filter(!is.na(Age) & !is.na(Sex) & time_period == "night"),  aes(x = Age, fill = Sex)) +
  geom_bar(stat = "count", position = "stack") +
  labs(y = "Count", title = "Distribution of Age of Persons Involved in Accidents")+ ylim(0,15000)

AgeSexTwo <- ggplot(data = SexAgeGraph, aes(x = Age, y = Percent, fill = Sex)) +
  geom_col(position = "stack") +
  ggtitle("Percent of Each Sex Who Are In Accidents By Age")+
  geom_abline(intercept = 50, slope = 0, alpha = 0.75, linetype = "dashed")

gridExtra::grid.arrange(AgeSexOne, AgeSexTwo)
```

# Distribution of Age of Persons Involved in Accidents

* Majority of accidents occur at night (8:00 pm to midnight)
* Fewest accidents occur during the evening (5:00 pm to 8:00 pm)
* Evening window is smallest and distorts accident count
* Fewer people over age 60 get in accidents in the evening
* Men are involved in more accidents than women across the board
* Men involvement in accidents is especially apparent between ages 16 and 75
* During night/twilight hours, proportion of men to women increases among older people
* Male and female involvement in accidents are most balanced during mid-day period.

### Late night
```{r Distribution of Age of Persons Involved in Accidents Evening Late Night, message=FALSE, warning=FALSE}
SexAgeGraph <- Master_Dataframe %>% 
  filter(!is.na(Sex) & !is.na(Age) & time_period == "late_night") %>% 
  group_by(Age, Sex) %>% 
  summarise(Count = n()) %>% 
  mutate(Percent = Count/sum(Count)*100)

AgeSexOne <- ggplot(Master_Dataframe %>% filter(!is.na(Age) & !is.na(Sex) & time_period == "late_night"),  aes(x = Age, fill = Sex)) +
  geom_bar(stat = "count", position = "stack") +
  labs(y = "Count", title = "Distribution of Age of Persons Involved in Accidents")+ ylim(0,15000)

AgeSexTwo <- ggplot(data = SexAgeGraph, aes(x = Age, y = Percent, fill = Sex)) +
  geom_col(position = "stack") +
  ggtitle("Percent of Each Sex Who Are In Accidents By Age")+
  geom_abline(intercept = 50, slope = 0, alpha = 0.75, linetype = "dashed")

gridExtra::grid.arrange(AgeSexOne, AgeSexTwo)
```

# Accidents Caused By Intoxication And Gender Over The Day

* Majority of alcohol-related accidents occur late at night (midnight to 5:00 am)
* Very few accidents involving alcohol in the morning 
* Spike in accidents among 24-year-old men getting into accidents in the morning 
* Men between the ages of 20 and 60 remain the most at risk of getting into an accident while intoxicated during the evening and late night periods
* Late at night, when the majority of accidents take place, more than half of all accidents are caused by drunk men
* Women are generally involved in very few accidents involving alcohol across the board
* At night and very late into the night, a decent-sized segment of the female population gets into accidents due to alcohol


### Morning

``` {r Alcohol Morning}
Master_DataframeMini <- Master_Dataframe %>% 
  filter(time_period == "morning") 

LongAlcSexAge <- Master_DataframeMini %>%
  filter(!is.na(Alcohol_involvement)) %>%
  filter(!is.na(Sex)) %>%
  filter(!is.na(Age)) %>%
  mutate(grp = paste0(Sex,Alcohol_involvement)) %>% 
  mutate(grp = factor(paste0(Sex, Alcohol_involvement), 
                      levels = c("femaleNo (Alcohol Not Involved)", 
                                 "femaleYes (Alcohol Involved)",
                                 "maleNo (Alcohol Not Involved)", 
                                 "maleYes (Alcohol Involved)"
                                 ))) %>% 
  group_by(Age, grp) %>%
  summarise(Accident_count = n()) %>% 
  mutate(perc = Accident_count / sum(Accident_count) * 100) %>%
  mutate(grp = fct_recode(grp,
                          "Female, No Alcohol" = "femaleNo (Alcohol Not Involved)",
                          "Female, Alcohol Involved" = "femaleYes (Alcohol Involved)",
                          "Male, No Alcohol" = "maleNo (Alcohol Not Involved)",
                          "Male, Alcohol Involved" = "maleYes (Alcohol Involved)"
                          ))

AgeSexAlcOne <- ggplot(Master_DataframeMini %>% filter(!is.na(Sex)) %>% filter(!is.na(Alcohol_involvement)) %>% filter(!is.na(Age)), aes(x = Age, fill =  paste0(Sex,Alcohol_involvement))) +
  geom_bar(stat = "count", position = "stack") +
  labs(fill = "Group")+
  scale_fill_manual(labels = c("femaleNo (Alcohol Not Involved)" = "Female, No Alcohol",
                               "femaleYes (Alcohol Involved)" = "Female, Alcohol Involved",
                               "maleNo (Alcohol Not Involved)" = "Male, No Alcohol",
                               "maleYes (Alcohol Involved)" = "Male, Alcohol Involved"),
                    values = c("coral4", "coral1", "dodgerblue1", "dodgerblue4")) + ylim(0,8000)

AgeSexAlcTwo <- ggplot(LongAlcSexAge, aes(x = Age, y = perc, fill = grp)) +
  geom_col(position = "stack") +
  scale_fill_manual(breaks = c("Female, No Alcohol", "Female, Alcohol Involved", "Male, No Alcohol", "Male, Alcohol Involved"),
                    labels = c("Female, No Alcohol", "Female, Alcohol Involved", "Male, No Alcohol", "Male, Alcohol Involved"),
                    values = c("coral4", "coral1", "dodgerblue1", "dodgerblue4")) +
  labs(title = "Percent of Accidents by Age, Sex, and Intoxication Level",
       x = "Age",
       y = "Percent of Accidents",
       fill = "Group") +
  theme_minimal()
rm("Master_DataframeMini")
gridExtra::grid.arrange(AgeSexAlcOne, AgeSexAlcTwo)
```

# Accidents Caused By Intoxication And Gender Over The Day

* Majority of alcohol-related accidents occur late at night (midnight to 5:00 am)
* Very few accidents involving alcohol in the morning 
* Spike in accidents among 24-year-old men getting into accidents in the morning 
* Men between the ages of 20 and 60 remain the most at risk of getting into an accident while intoxicated during the evening and late night periods
* Late at night, when the majority of accidents take place, more than half of all accidents are caused by drunk men
* Women are generally involved in very few accidents involving alcohol across the board
* At night and very late into the night, a decent-sized segment of the female population gets into accidents due to alcohol

### Mid-Day

``` {r Alcohol MidDay}
Master_DataframeMini <- Master_Dataframe %>% 
  filter(time_period == "midday") 

LongAlcSexAge <- Master_DataframeMini %>%
  filter(!is.na(Alcohol_involvement)) %>%
  filter(!is.na(Sex)) %>%
  filter(!is.na(Age)) %>%
  mutate(grp = paste0(Sex,Alcohol_involvement)) %>% 
  mutate(grp = factor(paste0(Sex, Alcohol_involvement), 
                      levels = c("femaleNo (Alcohol Not Involved)", 
                                 "femaleYes (Alcohol Involved)",
                                 "maleNo (Alcohol Not Involved)", 
                                 "maleYes (Alcohol Involved)"
                                 ))) %>% 
  group_by(Age, grp) %>%
  summarise(Accident_count = n()) %>% 
  mutate(perc = Accident_count / sum(Accident_count) * 100) %>%
  mutate(grp = fct_recode(grp,
                          "Female, No Alcohol" = "femaleNo (Alcohol Not Involved)",
                          "Female, Alcohol Involved" = "femaleYes (Alcohol Involved)",
                          "Male, No Alcohol" = "maleNo (Alcohol Not Involved)",
                          "Male, Alcohol Involved" = "maleYes (Alcohol Involved)"
                          ))

AgeSexAlcOne <- ggplot(Master_DataframeMini %>% filter(!is.na(Sex)) %>% filter(!is.na(Alcohol_involvement)) %>% filter(!is.na(Age)), aes(x = Age, fill =  paste0(Sex,Alcohol_involvement))) +
  geom_bar(stat = "count", position = "stack") +
  labs(fill = "Group")+
  scale_fill_manual(labels = c("femaleNo (Alcohol Not Involved)" = "Female, No Alcohol",
                               "femaleYes (Alcohol Involved)" = "Female, Alcohol Involved",
                               "maleNo (Alcohol Not Involved)" = "Male, No Alcohol",
                               "maleYes (Alcohol Involved)" = "Male, Alcohol Involved"),
                    values = c("coral4", "coral1", "dodgerblue1", "dodgerblue4"))+ ylim(0,8000)

AgeSexAlcTwo <- ggplot(LongAlcSexAge, aes(x = Age, y = perc, fill = grp)) +
  geom_col(position = "stack") +
  scale_fill_manual(breaks = c("Female, No Alcohol", "Female, Alcohol Involved", "Male, No Alcohol", "Male, Alcohol Involved"),
                    labels = c("Female, No Alcohol", "Female, Alcohol Involved", "Male, No Alcohol", "Male, Alcohol Involved"),
                    values = c("coral4", "coral1", "dodgerblue1", "dodgerblue4")) +
  labs(title = "Percent of Accidents by Age, Sex, and Intoxication Level",
       x = "Age",
       y = "Percent of Accidents",
       fill = "Group") +
  theme_minimal()
rm("Master_DataframeMini")
gridExtra::grid.arrange(AgeSexAlcOne, AgeSexAlcTwo)

```

# Accidents Caused By Intoxication And Gender Over The Day

* Majority of alcohol-related accidents occur late at night (midnight to 5:00 am)
* Very few accidents involving alcohol in the morning 
* Spike in accidents among 24-year-old men getting into accidents in the morning 
* Men between the ages of 20 and 60 remain the most at risk of getting into an accident while intoxicated during the evening and late night periods
* Late at night, when the majority of accidents take place, more than half of all accidents are caused by drunk men
* Women are generally involved in very few accidents involving alcohol across the board
* At night and very late into the night, a decent-sized segment of the female population gets into accidents due to alcohol

### Evening

``` {r Alcohol Evening}
Master_DataframeMini <- Master_Dataframe %>% 
  filter(time_period == "evening") 

LongAlcSexAge <- Master_DataframeMini %>%
  filter(!is.na(Alcohol_involvement)) %>%
  filter(!is.na(Sex)) %>%
  filter(!is.na(Age)) %>%
  mutate(grp = paste0(Sex,Alcohol_involvement)) %>% 
  mutate(grp = factor(paste0(Sex, Alcohol_involvement), 
                      levels = c("femaleNo (Alcohol Not Involved)", 
                                 "femaleYes (Alcohol Involved)",
                                 "maleNo (Alcohol Not Involved)", 
                                 "maleYes (Alcohol Involved)"
                                 ))) %>% 
  group_by(Age, grp) %>%
  summarise(Accident_count = n()) %>% 
  mutate(perc = Accident_count / sum(Accident_count) * 100) %>%
  mutate(grp = fct_recode(grp,
                          "Female, No Alcohol" = "femaleNo (Alcohol Not Involved)",
                          "Female, Alcohol Involved" = "femaleYes (Alcohol Involved)",
                          "Male, No Alcohol" = "maleNo (Alcohol Not Involved)",
                          "Male, Alcohol Involved" = "maleYes (Alcohol Involved)"
                          ))

AgeSexAlcOne <- ggplot(Master_DataframeMini %>% filter(!is.na(Sex)) %>% filter(!is.na(Alcohol_involvement)) %>% filter(!is.na(Age)), aes(x = Age, fill =  paste0(Sex,Alcohol_involvement))) +
  geom_bar(stat = "count", position = "stack") +
  labs(fill = "Group")+
  scale_fill_manual(labels = c("femaleNo (Alcohol Not Involved)" = "Female, No Alcohol",
                               "femaleYes (Alcohol Involved)" = "Female, Alcohol Involved",
                               "maleNo (Alcohol Not Involved)" = "Male, No Alcohol",
                               "maleYes (Alcohol Involved)" = "Male, Alcohol Involved"),
                    values = c("coral4", "coral1", "dodgerblue1", "dodgerblue4"))+ ylim(0,8000)

AgeSexAlcTwo <- ggplot(LongAlcSexAge, aes(x = Age, y = perc, fill = grp)) +
  geom_col(position = "stack") +
  scale_fill_manual(breaks = c("Female, No Alcohol", "Female, Alcohol Involved", "Male, No Alcohol", "Male, Alcohol Involved"),
                    labels = c("Female, No Alcohol", "Female, Alcohol Involved", "Male, No Alcohol", "Male, Alcohol Involved"),
                    values = c("coral4", "coral1", "dodgerblue1", "dodgerblue4")) +
  labs(title = "Percent of Accidents by Age, Sex, and Intoxication Level",
       x = "Age",
       y = "Percent of Accidents",
       fill = "Group") +
  theme_minimal()
rm("Master_DataframeMini")
gridExtra::grid.arrange(AgeSexAlcOne, AgeSexAlcTwo)


```

# Accidents Caused By Intoxication And Gender Over The Day

* Majority of alcohol-related accidents occur late at night (midnight to 5:00 am)
* Very few accidents involving alcohol in the morning 
* Spike in accidents among 24-year-old men getting into accidents in the morning 
* Men between the ages of 20 and 60 remain the most at risk of getting into an accident while intoxicated during the evening and late night periods
* Late at night, when the majority of accidents take place, more than half of all accidents are caused by drunk men
* Women are generally involved in very few accidents involving alcohol across the board
* At night and very late into the night, a decent-sized segment of the female population gets into accidents due to alcohol

### Night

``` {r Alcohol Night}
Master_DataframeMini <- Master_Dataframe %>% 
  filter(time_period == "night") 

LongAlcSexAge <- Master_DataframeMini %>%
  filter(!is.na(Alcohol_involvement)) %>%
  filter(!is.na(Sex)) %>%
  filter(!is.na(Age)) %>%
  mutate(grp = paste0(Sex,Alcohol_involvement)) %>% 
  mutate(grp = factor(paste0(Sex, Alcohol_involvement), 
                      levels = c("femaleNo (Alcohol Not Involved)", 
                                 "femaleYes (Alcohol Involved)",
                                 "maleNo (Alcohol Not Involved)", 
                                 "maleYes (Alcohol Involved)"
                                 ))) %>% 
  group_by(Age, grp) %>%
  summarise(Accident_count = n()) %>% 
  mutate(perc = Accident_count / sum(Accident_count) * 100) %>%
  mutate(grp = fct_recode(grp,
                          "Female, No Alcohol" = "femaleNo (Alcohol Not Involved)",
                          "Female, Alcohol Involved" = "femaleYes (Alcohol Involved)",
                          "Male, No Alcohol" = "maleNo (Alcohol Not Involved)",
                          "Male, Alcohol Involved" = "maleYes (Alcohol Involved)"
                          ))

AgeSexAlcOne <- ggplot(Master_DataframeMini %>% filter(!is.na(Sex)) %>% filter(!is.na(Alcohol_involvement)) %>% filter(!is.na(Age)), aes(x = Age, fill =  paste0(Sex,Alcohol_involvement))) +
  geom_bar(stat = "count", position = "stack") +
  labs(fill = "Group")+
  scale_fill_manual(labels = c("femaleNo (Alcohol Not Involved)" = "Female, No Alcohol",
                               "femaleYes (Alcohol Involved)" = "Female, Alcohol Involved",
                               "maleNo (Alcohol Not Involved)" = "Male, No Alcohol",
                               "maleYes (Alcohol Involved)" = "Male, Alcohol Involved"),
                    values = c("coral4", "coral1", "dodgerblue1", "dodgerblue4"))+ ylim(0,8000)

AgeSexAlcTwo <- ggplot(LongAlcSexAge, aes(x = Age, y = perc, fill = grp)) +
  geom_col(position = "stack") +
  scale_fill_manual(breaks = c("Female, No Alcohol", "Female, Alcohol Involved", "Male, No Alcohol", "Male, Alcohol Involved"),
                    labels = c("Female, No Alcohol", "Female, Alcohol Involved", "Male, No Alcohol", "Male, Alcohol Involved"),
                    values = c("coral4", "coral1", "dodgerblue1", "dodgerblue4")) +
  labs(title = "Percent of Accidents by Age, Sex, and Intoxication Level",
       x = "Age",
       y = "Percent of Accidents",
       fill = "Group") +
  theme_minimal()
rm("Master_DataframeMini")
gridExtra::grid.arrange(AgeSexAlcOne, AgeSexAlcTwo)


```

# Accidents Caused By Intoxication And Gender Over The Day

* Majority of alcohol-related accidents occur late at night (midnight to 5:00 am)
* Very few accidents involving alcohol in the morning 
* Spike in accidents among 24-year-old men getting into accidents in the morning 
* Men between the ages of 20 and 60 remain the most at risk of getting into an accident while intoxicated during the evening and late night periods
* Late at night, when the majority of accidents take place, more than half of all accidents are caused by drunk men
* Women are generally involved in very few accidents involving alcohol across the board
* At night and very late into the night, a decent-sized segment of the female population gets into accidents due to alcohol

### Late Night

``` {r Alcohol Late Night}
Master_DataframeMini <- Master_Dataframe %>% 
  filter(time_period == "late_night") 

LongAlcSexAge <- Master_DataframeMini %>%
  filter(!is.na(Alcohol_involvement)) %>%
  filter(!is.na(Sex)) %>%
  filter(!is.na(Age)) %>%
  mutate(grp = paste0(Sex,Alcohol_involvement)) %>% 
  mutate(grp = factor(paste0(Sex, Alcohol_involvement), 
                      levels = c("femaleNo (Alcohol Not Involved)", 
                                 "femaleYes (Alcohol Involved)",
                                 "maleNo (Alcohol Not Involved)", 
                                 "maleYes (Alcohol Involved)"
                                 ))) %>% 
  group_by(Age, grp) %>%
  summarise(Accident_count = n()) %>% 
  mutate(perc = Accident_count / sum(Accident_count) * 100) %>%
  mutate(grp = fct_recode(grp,
                          "Female, No Alcohol" = "femaleNo (Alcohol Not Involved)",
                          "Female, Alcohol Involved" = "femaleYes (Alcohol Involved)",
                          "Male, No Alcohol" = "maleNo (Alcohol Not Involved)",
                          "Male, Alcohol Involved" = "maleYes (Alcohol Involved)"
                          ))

AgeSexAlcOne <- ggplot(Master_DataframeMini %>% filter(!is.na(Sex)) %>% filter(!is.na(Alcohol_involvement)) %>% filter(!is.na(Age)), aes(x = Age, fill =  paste0(Sex,Alcohol_involvement))) +
  geom_bar(stat = "count", position = "stack") +
  labs(fill = "Group")+
  scale_fill_manual(labels = c("femaleNo (Alcohol Not Involved)" = "Female, No Alcohol",
                               "femaleYes (Alcohol Involved)" = "Female, Alcohol Involved",
                               "maleNo (Alcohol Not Involved)" = "Male, No Alcohol",
                               "maleYes (Alcohol Involved)" = "Male, Alcohol Involved"),
                    values = c("coral4", "coral1", "dodgerblue1", "dodgerblue4"))+ ylim(0,8000)

AgeSexAlcTwo <- ggplot(LongAlcSexAge, aes(x = Age, y = perc, fill = grp)) +
  geom_col(position = "stack") +
  scale_fill_manual(breaks = c("Female, No Alcohol", "Female, Alcohol Involved", "Male, No Alcohol", "Male, Alcohol Involved"),
                    labels = c("Female, No Alcohol", "Female, Alcohol Involved", "Male, No Alcohol", "Male, Alcohol Involved"),
                    values = c("coral4", "coral1", "dodgerblue1", "dodgerblue4")) +
  labs(title = "Percent of Accidents by Age, Sex, and Intoxication Level",
       x = "Age",
       y = "Percent of Accidents",
       fill = "Group") +
  theme_minimal()
rm("Master_DataframeMini")
gridExtra::grid.arrange(AgeSexAlcOne, AgeSexAlcTwo)


```


# Relationship between Hour of Day and Age of Persons Involved in Accidents, Colored by Injury Severity and Faceted by Sex 

* Younger individuals tend to be involved in most fatal and non-fatal accidents throughout the day.
* Spread of age decreases throughout the day and is smaller at night.
* The midday period has the largest spread of age.
* Median age is near the 25 at night and during the late night periods.
* Median age is higher for fatal accidents across all times.


```{r Graph 6: Relationship between Hour of Day and Age of Persons Involved in Accidents, Colored by Injury Severity and Faceted by Sex}

temp_df <- Master_Dataframe %>% 
  filter(!is.na(Sex) & time_period != "unknown") %>%
  mutate(time_period = fct_relevel(time_period, "morning", "midday", "evening", "night", "late_night")) %>%
  mutate(time_period = fct_recode(time_period,
                                   "Morning" = "morning",
                                   "Midday" = "midday",
                                   "Evening" = "evening",
                                   "Night" = "night",
                                   "Late Night" = "late_night"))

ggplot(temp_df, aes(y = Age, x = Injury_Severity_Basic)) +
  geom_boxplot() +
  facet_wrap(~ time_period) +
  labs(y = "Age", x = "Was The Accident Fatal", title = "Relationship between Age, Injury Severity, and Hour of Day") +
  guides(color = guide_legend(override.aes = list(alpha = 1)))

```

# Boxplot of Age by Injury Severity Over Time

* Accidents involving younger individuals increase over the course of the day.
* Age of accidents without injury decreases by about a decade from morning to late night.
* Mid-day period has the largest spread of age due to people of all ages being awake.
* Spread of age narrows significantly in late night, where most accidents involve younger individuals (usually around the age of 25).
* Exception to this are individuals who died prior to the crash, which remains an older demographic with a larger spread throughout the day.

### Morning 

``` {r Graph 8.0, fig.cap="Boxplot of Age by Injury Severity Morning"}
ggplot(Master_Dataframe %>% filter(time_period == "morning"), aes(x = Injury_severity, y = Age)) +
  geom_boxplot() +
  labs(title = "Boxplot of Age by Injury Severity Morning", x = "Injury Severity", y = "Age") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

# Boxplot of Age by Injury Severity Over Time

* Accidents involving younger individuals increase over the course of the day.
* Age of accidents without injury decreases by about a decade from morning to late night.
* Mid-day period has the largest spread of age due to people of all ages being awake.
* Spread of age narrows significantly in late night, where most accidents involve younger individuals (usually around the age of 25).
* Exception to this are individuals who died prior to the crash, which remains an older demographic with a larger spread throughout the day.

### Midday

``` {r Graph 8.1, fig.cap="Boxplot of Age by Injury Severity midday"}
ggplot(Master_Dataframe%>% filter(time_period == "midday"), aes(x = Injury_severity, y = Age)) +
  geom_boxplot() +
  labs(title = "Boxplot of Age by Injury Severity Midday", x = "Injury Severity", y = "Age") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

# Boxplot of Age by Injury Severity Over Time

* Accidents involving younger individuals increase over the course of the day.
* Age of accidents without injury decreases by about a decade from morning to late night.
* Mid-day period has the largest spread of age due to people of all ages being awake.
* Spread of age narrows significantly in late night, where most accidents involve younger individuals (usually around the age of 25).
* Exception to this are individuals who died prior to the crash, which remains an older demographic with a larger spread throughout the day.

### Evening 

``` {r Graph 8.2, fig.cap="Boxplot of Age by Injury Severity evening"}
ggplot(Master_Dataframe%>% filter(time_period == "evening"), aes(x = Injury_severity, y = Age)) +
  geom_boxplot() +
  labs(title = "Boxplot of Age by Injury Severity Evening", x = "Injury Severity", y = "Age") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

# Boxplot of Age by Injury Severity Over Time

* Accidents involving younger individuals increase over the course of the day.
* Age of accidents without injury decreases by about a decade from morning to late night.
* Mid-day period has the largest spread of age due to people of all ages being awake.
* Spread of age narrows significantly in late night, where most accidents involve younger individuals (usually around the age of 25).
* Exception to this are individuals who died prior to the crash, which remains an older demographic with a larger spread throughout the day.

### Night 

``` {r Graph 8.3, fig.cap="Boxplot of Age by Injury Severity night"}
ggplot(Master_Dataframe%>% filter(time_period == "night"), aes(x = Injury_severity, y = Age)) +
  geom_boxplot() +
  labs(title = "Boxplot of Age by Injury Severity Night", x = "Injury Severity", y = "Age") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

# Boxplot of Age by Injury Severity Over Time

* Accidents involving younger individuals increase over the course of the day.
* Age of accidents without injury decreases by about a decade from morning to late night.
* Mid-day period has the largest spread of age due to people of all ages being awake.
* Spread of age narrows significantly in late night, where most accidents involve younger individuals (usually around the age of 25).
* Exception to this are individuals who died prior to the crash, which remains an older demographic with a larger spread throughout the day.

### Late Night 

``` {r Graph 8.4, fig.cap="Boxplot of Age by Injury Severity Late Night"}
ggplot(Master_Dataframe%>% filter(time_period == "late_night"), aes(x = Injury_severity, y = Age)) +
  geom_boxplot() +
  labs(title = "Boxplot of Age by Injury Severity Late Night", x = "Injury Severity", y = "Age") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```


# Distribution of Age by Sex Involved in Accidents

* Morning, midday, and evening: almost identical distribution of men and women
* Late evening to late night: lower median age (25 years old) and a peak of accidents among young individuals around 17 years old
* Median age: around 35 years old during the morning, midday, and evening
* Median age: 25 years old during the late evening to late night
* Men and women have mostly similar distribution of accidents throughout all time periods.

```{r Graph 7: Distribution of Age by Sex Involved in Accidents}

temp_df <- Master_Dataframe %>% 
  filter(!is.na(Sex) & time_period != "unknown") %>%
  mutate(time_period = fct_relevel(time_period, "morning", "midday", "evening", "night", "late_night")) %>%
  mutate(time_period = fct_recode(time_period,
                                   "Morning" = "morning",
                                   "Midday" = "midday",
                                   "Evening" = "evening",
                                   "Night" = "night",
                                   "Late Night" = "late_night"))

ggplot(temp_df %>% filter(!is.na(Sex) & !is.na(time_period)), aes(x = Sex, y = Age)) +
    geom_boxplot(aes(fill = "indianred3")) +
    geom_violin(aes(fill = "dodgerblue"), alpha = 0.5) +
    labs(x = "Sex", y = "Age", title = "Distribution of Age by Sex Involved in Accidents by time") +
    theme_minimal() +
    guides(fill = "none") +
    facet_wrap( ~ time_period)
```



# Accident Characteristics Over Time

* Automobiles are involved in the most accidents across all time periods.
* Majority of vehicles on the road are automobiles.
* Midday period sees the most serious/fatal injuries for those in automobiles.
* Nearly `r Master_Dataframe %>% filter(Injury_severity %in% c("Fatal Injury", "Died Prior to Crash", "Suspected Serious Injury"), time_period == "midday", Vehicle_body_type == "Automobiles") %>% summarize(count = n()) %>% pull(count) %>% round(-4) %>% format(big.mark = ",", scientific = FALSE)` serious or fatal accidents occur midday from automobiles.
* Evening period generally sees fewer serious or fatal accidents.
* Vans and minivans also get into accidents during morning and midday.

```{r Graph 8: Number of Accidents by Vehicle Body Type and Injury Severity}

temp_df <- Master_Dataframe %>% 
  filter(time_period != "unknown") %>% 
  mutate(time_period = fct_relevel(time_period, "morning", "midday", "evening", "night", "late_night")) %>%
  mutate(time_period = fct_recode(time_period,
                                   "Morning" = "morning",
                                   "Midday" = "midday",
                                   "Evening" = "evening",
                                   "Night" = "night",
                                   "Late Night" = "late_night"))

ggplot(temp_df , aes(y = Vehicle_body_type, fill = Injury_severity)) +
    geom_bar(position = "stack") +
    labs(y = "Vehicle body type", x = "Number of accidents", title = "Number of Accidents by Vehicle Body Type and Injury Severity")+
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    scale_fill_manual(values = c("lightblue", "orange", "mediumpurple1", "red1", "darkred", "tan1", "indianred3"))+
    theme_minimal()+
    theme(legend.position = "bottom", # Move legend to bottom
          legend.title = element_blank())  +
    facet_wrap( ~ time_period, nrow = 1)+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

# Moving Window Analysis:

* Number of accidents per day (mean in window) decreasing over the past two decades
* Recently saw an uptick
* Spread of mean values per window had a lot of variation in the late 20th century
* Consistency increased around 2004
* Consistency has remained reasonably consistent with some windows being less uniform than in the 2004-2008 period
* Recent uptick is notable, but significantly lower than two decades ago.

``` {r Moving Window Statistics, message=FALSE}

SingleWindow <- function(statistic, data, colname = NULL) {
  if (!is.data.frame(data)) {
    stop("The input data must be a dataframe.")
  }
  switch(statistic,
         "correlation" = list(Value = cor(data[,2], data[,3]), Midpoint = data[ceiling(nrow(data)/2), 1]),
         "p value" = list(Value = cor.test(data[,2], data[,3])$p.value, Midpoint = data[ceiling(nrow(data)/2), 1]),
         "OLS" = list(Value = summary(lm(data[,3] ~ data[,2]))$coefficients, Midpoint = data[ceiling(nrow(data)/2), 1]),
         "mean" = list(Value = mean(data[[colname]]), Midpoint = data[ceiling(nrow(data)/2), 1]), # Second column only
         stop("The input statistic must be one of 'correlation', 'p value', 'mean', or 'OLS'.")
  )
}


MovingWindow <- function(data, posix_col, col1, col2, window_days, step_size, statistic) {
  # Ensure the input POSIX column is in POSIXct format
  data[[posix_col]] <- as.POSIXct(data[[posix_col]])
  
  # Calculate the minimum and maximum POSIX values in the dataset
  min_date <- min(data[[posix_col]])
  max_date <- max(data[[posix_col]])
  
  # Convert window_days and step_size to seconds
  window_seconds <- window_days * 24 * 60 * 60
  step_seconds <- step_size * 24 * 60 * 60
  
  # Set the starting date for the moving window
  current_date <- min_date
  
  results = list()
  # Iterate through the dataset using the moving window
  while (current_date + window_seconds <= max_date) {
    # Filter the data within the moving window
    window_data <- data[data[[posix_col]] >= current_date & data[[posix_col]] <= current_date + window_seconds, c(posix_col, col1, col2)]
    
    # Select the posix_col, col1, and col2 using dplyr and set it equal to win_val
    win_val <- window_data %>%
      select(all_of(c(posix_col, col1, col2)))
    
    # Print the win_val dataframe for the current window
    # print(colnames(win_val))
    
    
    if (statistic != "mean") {
      result <- SingleWindow(statistic, win_val)
    }
    if (statistic == "mean") {
      result <- SingleWindow(statistic, win_val, colname = col1)
    }
    
    results <- rbind(results, data.frame(DateTime = current_date,
                                         Value = result$Value[1],
                                         Midpoint = as.POSIXct(result$Midpoint$Datetime)))
    
    # Move the window by step_size
    current_date <- current_date + step_seconds
    
  }
  
  # print(results)
  ggplot(data = results, aes(x=Midpoint,Value))+
    geom_point()
  return(results)
}

# MovingWindow(Master_Dataframe, "Datetime", "Number_of_persons_involved", "Number_of_vehicles_involved", 30, 15, "correlation")

DayMeanFind <- Master_Dataframe %>%
  group_by(Datetime) %>%
  summarize(rows_on_date = n()) %>%
  filter(!is.na(rows_on_date))%>%
  mutate(rows_on_date = as.numeric(rows_on_date))

MW_Num_Per_Day <- MovingWindow(DayMeanFind, "Datetime", "rows_on_date", "rows_on_date", 60, 15, "mean")
ggplot(data = MW_Num_Per_Day, aes(x=Midpoint,Value))+
    geom_point() +
  labs(
    title = "Mean Accidents Per Day in 60 Day Window With 15 Day Overlap",
    x = "Date",
    y = "Mean Number of Accidents Per Day"
  ) +
  geom_smooth(method = "loess")

rm("MW_Num_Per_Day","DayMeanFind")
```

# Moving Window Analysis:

We can see that the northeastern states have consistently been safer than the other regions and that the western states have been the greatest risk over the past twenty years. The south saw a noticeable decrease in accidents between 1996 and 2011 which the other regions echoed but to a lesser extent. The Midwest has not seen as significant an uptick recently as compared to the other regions and has nearly flat lined over the past six years.

``` {r Region Analysis Daily, message=FALSE}

# filter by region and calculate daily mean
south <- Master_Dataframe %>% 
  filter(region == "South") %>% 
  group_by(Datetime) %>% 
  summarize(rows_on_date = n()) %>% 
  filter(!is.na(rows_on_date)) %>% 
  mutate(rows_on_date = as.numeric(rows_on_date))
southMW <- MovingWindow(south, "Datetime", "rows_on_date", "rows_on_date", 60, 15, "mean")

west <- Master_Dataframe %>% 
  filter(region == "West") %>% 
  group_by(Datetime) %>% 
  summarize(rows_on_date = n()) %>% 
  filter(!is.na(rows_on_date)) %>% 
  mutate(rows_on_date = as.numeric(rows_on_date))
westMW <- MovingWindow(west, "Datetime", "rows_on_date", "rows_on_date", 60, 15, "mean")

northeast <- Master_Dataframe %>% 
  filter(region == "Northeast") %>% 
  group_by(Datetime) %>% 
  summarize(rows_on_date = n()) %>% 
  filter(!is.na(rows_on_date)) %>% 
  mutate(rows_on_date = as.numeric(rows_on_date))
northeastMW <- MovingWindow(northeast, "Datetime", "rows_on_date", "rows_on_date", 60, 15, "mean")

midwest <- Master_Dataframe %>%
  filter(region == "Midwest") %>% 
  group_by(Datetime) %>% 
  summarize(rows_on_date = n()) %>% 
  filter(!is.na(rows_on_date)) %>% 
  mutate(rows_on_date = as.numeric(rows_on_date))
midwestMW <- MovingWindow(midwest, "Datetime", "rows_on_date", "rows_on_date", 60, 15, "mean")


AllRegionsLong <- bind_rows(
  southMW %>% mutate(region = "South") %>% slice_sample(n = 25000, replace = FALSE),
  westMW %>% mutate(region = "West") %>% slice_sample(n = 25000, replace = FALSE),
  northeastMW %>% mutate(region = "Northeast") %>% slice_sample(n = 25000, replace = FALSE),
  midwestMW %>% mutate(region = "Midwest") %>% slice_sample(n = 25000, replace = FALSE) 
)

ggplot(data = AllRegionsLong, aes(x=Midpoint,y=Value, col = region))+
  # geom_point(alpha = 1/4) +
  labs(
    title = "Regional Mean Accidents (loess) Per Day in 60 Day Window (15 Day Overlap)",
    x = "Date",
    y = "Mean Number of Accidents Per Day",
    caption = "To reduce render time, sample sizes have been capped at 25,000 per region"
  ) +
  scale_x_datetime(date_breaks = "2 years", date_labels = "%Y") +
  geom_smooth(method = "loess", aes(group = region), formula = "y ~ x", se = FALSE, span = 0.6) +
  theme(legend.position = "top",
        panel.grid.major = element_line(color = "gray", linetype = "dashed"),
        panel.grid.minor = element_blank()) +
  guides(col = guide_legend(title.position = "top", nrow = 1))+
  scale_color_discrete(name = "Regions:")

rm("south", "west", "midwest","northeast","southMW", "westMW", "northeastMW", "midwestMW","AllRegionsLong") 

```

# Discussion:

* Majority of accidents occur in July, with the fewest in February, following a cyclic pattern
* New Year's and July 4th are very dangerous to be on the road
* Men get in car accidents more frequently than women no matter the time
* Women are less likely to get into an accident due to intoxication, but the largest number of women in accidents due to alcohol is late at night
* Minor accidents tend to involve younger individuals, whereas fatal accidents tend to involve older individuals
* Majority of accidents occur in the South, with the fewest in the Northeast
* South only region that does not follow a cyclic pattern over the year


# Discussion Continued:
* Accidents start around 9:00 am (8:00 am on weekdays), become more dangerous around 4:00 pm, and the twilight hours are the most dangerous
* Late-night accidents involve a significant number of young people, with the majority being men, and involve alcohol
* Fridays and Saturdays are particularly dangerous, especially during the evening and early morning hours



# References

```{r Citation, include = FALSE}
citation()
citation("dplyr")
citation("ggplot2")
citation("gridExtra")
citation("tidyverse")
citation("lubridate")

```

[1]  R Core Team (2022). R: A language and environment for statistical computing. R Foundation for Statistical Computing,
  Vienna, Austria. URL https://www.R-project.org/.

[2]  Wickham H, François R, Henry L, Müller K, Vaughan D (2023). _dplyr: A Grammar of Data Manipulation_. R package version
  1.1.0, <https://CRAN.R-project.org/package=dplyr>.

[3]  H. Wickham. ggplot2: Elegant Graphics for Data Analysis. Springer-Verlag New York, 2016.

[4]  Auguie B (2017). _gridExtra: Miscellaneous Functions for "Grid" Graphics_. R package version 2.3,
  <https://CRAN.R-project.org/package=gridExtra>.

[5]  Wickham H, Averick M, Bryan J, Chang W, McGowan LD, François R, Grolemund G, Hayes A, Henry L, Hester J, Kuhn M,
  Pedersen TL, Miller E, Bache SM, Müller K, Ooms J, Robinson D, Seidel DP, Spinu V, Takahashi K, Vaughan D, Wilke C, Woo
  K, Yutani H (2019). “Welcome to the tidyverse.” _Journal of Open Source Software_, *4*(43), 1686.
  doi:10.21105/joss.01686 <https://doi.org/10.21105/joss.01686>.

[6]  Garrett Grolemund, Hadley Wickham (2011). Dates and Times Made Easy with lubridate. Journal of Statistical Software,
  40(3), 1-25. URL https://www.jstatsoft.org/v40/i03/.
















