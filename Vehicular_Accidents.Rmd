---
title: "Vehicular Accidents Restructuring"
author: "William Kopans"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    theme: paper
    fig.width: 7 # Does this work?
    fig.height: 7 # Does this work?
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

library(here)
knitr::opts_chunk$set(echo = TRUE,
                      cache = TRUE,
                      cache.path = here::here(".cache"),
                      cache.size = 1000,
                      cache.lazy = TRUE,
                      cache.rebuild = TRUE,
                      cache.extra = list(png = here::here("images/"), pdf = here::here("documents/")))

```

# Remember to remove SetWD and use "tabs" to group similar plots
``` {r Import Dataset and libraries, message=FALSE}
setwd("/Volumes/Courses/ES218_A_SP/wokopa26/Vehicular accidents/Apr26")
library(ggplot2)
library(tidyverse)
library(lubridate)
library(ggridges)

Accidents_Original <- readRDS("farsp.RDS")

alcohol <- read.csv("alcohol.csv")
alcohol <- alcohol %>% 
  mutate(description = if_else(description %in% c("Unknown", "Not reported"), NA, description))

body_typ <- read.csv("body_typ.csv")
body_typ <- body_typ %>% 
  mutate(description = if_else(description %in% c("Unknown body type", "Not Reported"), NA, description))

col_names <- read.csv("column_name_description.csv")

inj_sev <- read.csv("inj_sev.csv")
inj_sev <- inj_sev %>% 
  mutate(description = if_else(description %in% c("Unknown/Not Reported", "N/A"), NA, description))

man_coll <- read.csv("man_coll.csv")
man_coll <- man_coll %>% 
  mutate(description = if_else(description %in% c("Not Reported", "Unknown"), NA, description))

sex <- read.csv("sex.csv")
sex <- sex %>% 
  mutate(description = if_else(description %in% c("not reported", "unknown"), NA, description))

state_code <- read.csv("state_code.csv")
```
# remember to remove setwd

``` {r Data Manipulation}
col_names <- setNames(col_names$column_name, col_names$description)
names(col_names) <- gsub(" ", "_", names(col_names))

Names_Changed <- Accidents_Original %>%
  rename(alcohol = drinking) %>% 
  left_join(state_code, by = c("state" = "state_code")) %>%
  left_join(sex, by = "sex") %>%
  left_join(man_coll, by = "man_coll") %>%
  left_join(inj_sev, by = "inj_sev") %>%
  left_join(body_typ, by = "body_typ") %>%
  left_join(alcohol, by = "alcohol") %>%
    mutate(across(c(year, month, day, hour, minute, age), ~replace(., . == 99, NA)),
         across(c(age), ~replace(., . == 999, NA))) %>%
  drop_na(c("year", "month", "day", "hour", "minute")) %>% 
  mutate(
    state = as.character(state_name),
    sex = as.character(description.x),
    man_coll = as.character(description.y),
    alcohol = as.character(description),
    inj_sev = as.character(description.x.x),
    body_typ = as.character(description.y.y),
    Datetime = ymd_hm(paste(year, month, day, hour, minute)),
    Month_Name = month(month, label = TRUE)
  ) %>%
  rename(!!!col_names) %>% 
  mutate(
    State = as.factor(State),
    County = as.factor(County),
    Manner_of_collision = as.factor(Manner_of_collision),
    Vehicle_body_type = as.factor(Vehicle_body_type),
    Sex = as.factor(Sex),
    Injury_severity = factor(Injury_severity, levels = c("No Apparent Injury", "Injured, Severity Unknown", "Possible Injury", "Suspected Minor Injury", "Suspected Serious Injury", "Non-incapacitating injury", "Fatal Injury", "Died Prior to Crash")),
    Injury_Severity_Basic = if_else(Injury_severity %in% c("Fatal Injury", "Died Prior to Crash"), "Fatal", "Non-Fatal"),
    Datetime = as.POSIXct(Datetime),
    Date = as.Date(Datetime),
    Accident_weekday = factor(wday(Datetime, label = TRUE), levels = c("Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat")),
    Year = year(Datetime)
    ) %>%
  filter(Age < 100) %>%
  select(-State, -description.x, -description.y, -description.x.x, -description.y.y,-description)


```

# Temporal Analysis - Move 41 out

### Graph 2: Number of Accidents per Month
```{r Graph 2: Number of Accidents per Month}
ggplot(Names_Changed %>% filter(!is.na(Datetime)), aes(x = month(Datetime, label = TRUE))) +
geom_bar() +
ggtitle("Number of Accidents per Month")
```

### Graph 3: Accident Rates Over Time
```{r Graph 3: Accident Rates Over Time}
ggplot(Names_Changed, aes(x = Date, y = after_stat(count))) +
geom_line(stat = "count") +
labs(x = "Date", y = "Accidents", title = "Accident Rates Over Time")
```

### Graph 4: Number of Accidents per Hour
```{r Graph 4: Number of Accidents per Hour}
ggplot(Names_Changed %>% filter(!is.na(Accident_hour)), aes(x = Accident_hour)) +
geom_bar() +
ggtitle("Number of Accidents per Hour")
```


### Graph 14: Number of Accidents by Hour of the Day and Month
```{r Graph 14: Number of Accidents by Hour of the Day and Month}
accidents_by_hour_month <- Names_Changed %>%
  group_by(Accident_hour, Month_Name) %>%
  summarize(Count = n()) %>%
  ungroup()

ggplot(accidents_by_hour_month, aes(x = Accident_hour, y = Count, fill = factor(Month_Name))) +
geom_col(position = "stack") +
labs(title = "Number of Accidents by Hour of the Day and Month") +
scale_fill_discrete(name = "Hour of the Day") +
theme_minimal()
```

### Graph 17: Density of Accidents by Day of Month and Time of Day
```{r Graph 17: Density of Accidents by Day of Month and Time of Day}
ggplot(Names_Changed, aes(x = Accident_hour, y = Accident_day)) +
geom_bin2d(bins = 20) +
labs(x = "Hour of day", y = "Day of month", fill = "Number of accidents", title = "Density of Accidents by Day of Month and Time of Day") +
  scale_y_continuous(breaks = seq(1, 31, by = 1))+
  scale_x_continuous(breaks = seq(0, 24, by = 1)) 

ggplot(Names_Changed, aes(x = Accident_hour, y = Date)) +
  geom_bin2d(bins = 30) +
  labs(x = "Hour of Day", y = "Date", fill = "Density of Accidents", title = "Density of Accidents by Date and Time of Day") +
  scale_y_date(date_breaks = "1 day", date_labels = "%d")+
  scale_x_continuous(breaks = seq(0, 24, by = 2)) +
  scale_fill_gradient(low = "white", high = "red") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))

ggplot(Names_Changed, aes(x = Accident_hour, y = Accident_day)) +
    geom_bin2d(bins = 30) +
    labs(x = "Hour of Day", y = "Day", fill = "Density of Accidents", title = "Density of Accidents by Day of Month and Time of Day")+
    scale_x_continuous(breaks = seq(0, 24, by = 2)) +
    scale_fill_gradient(low = "white", high = "red") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, vjust = 0.5))


```

### Graph 18: Total Number of Accidents by Day of the Week
```{r Graph 18: Total Number of Accidents by Day of the Week}
ggplot(Names_Changed, aes(x = Accident_weekday)) +
geom_bar() +
labs(x = "Day of week", y = "Number of accidents", title = "Total Number of Accidents by Day of the Week")
```

### Graph 19: Total Number of Accidents by Year
```{r Graph 19: Total Number of Accidents by Year}
ggplot(Names_Changed, aes(x = Accident_year)) +
geom_bar() +
labs(x = "Year", y = "Number of accidents", title = "Total Number of Accidents by Year")
```

### Graph 31: Bivariate relationships - Scatter plot
```{r Plot31, fig.cap="Scatter plot showing the relationship between the age of individuals involved in accidents and the number of persons involved."}
ggplot(data = Names_Changed, aes(x = Age, y = Number_of_persons_involved)) + 
  geom_point(alpha = 0.05) + 
  theme_minimal()
```

### Graph 41: Bubble plot for the number of accidents by state and injury severity - Not sure this is the best way to display this information, maybe have this for regions...
```{r Plot41, fig.cap="Bubble plot showing the number of accidents by state and injury severity, with bubble size indicating the number of accidents and color indicating injury severity."}
state_injury_severity <- Names_Changed %>% count(state_name, Injury_severity)

ggplot(data = state_injury_severity, aes(x = state_name, y = Injury_severity, size = n, color = Injury_severity)) +
  geom_point(alpha = 0.5) +
  theme_minimal() +
  labs(x = "State", y = "Injury Severity") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

### Graph 42: Bar plot for the number of accidents by month and year
```{r Plot42, fig.cap="Bar plot showing the number of accidents by month and year."}
monthly_accidents <- Names_Changed %>% count(Year = year(Datetime), Month = month(Datetime))

ggplot(data = monthly_accidents, aes(x = month(Month, label = TRUE), y = n, fill = as.factor(Year))) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  labs(x = "Month", y = "Number of Accidents", fill = "Year")
```

# Demographic Analysis

### Graph 5: Distribution of Age of Persons Involved in Accidents
```{r Graph 5: Distribution of Age of Persons Involved in Accidents}
AgeSexOne <- ggplot(Names_Changed %>% filter(!is.na(Age)) %>% filter(!is.na(Sex)), aes(x = Age, fill = Sex)) +
  geom_bar(stat = "count", position = "stack") +
  labs(y = "Count", title = "Distribution of Age of Persons Involved in Accidents")

SexAgeGraph <- Names_Changed %>% 
  filter(!is.na(Sex)) %>% 
  filter(!is.na(Age)) %>% 
  group_by(Age, Sex) %>% 
  summarise(Count = n()) %>% 
  mutate(Percent = Count/sum(Count)*100)

AgeSexTwo <- ggplot(data = SexAgeGraph, aes(x = Age, y = Percent, fill = Sex)) +
  geom_col(position = "stack") +
  ggtitle("Percent of Each Sex Who Are In Accidents By Age")+
  geom_abline(intercept = 50, slope = 0, alpha = 0.75, linetype = "dashed")

gridExtra::grid.arrange(AgeSexOne, AgeSexTwo)

# New:

LongAlcSexAge <- Names_Changed %>%
  filter(!is.na(Alcohol_involvement)) %>%
  filter(!is.na(Sex)) %>%
  filter(!is.na(Age)) %>%
  mutate(grp = paste0(Sex,Alcohol_involvement)) %>% 
  mutate(grp = factor(paste0(Sex, Alcohol_involvement), 
                      levels = c("femaleNo (Alcohol Not Involved)", 
                                 "maleNo (Alcohol Not Involved)", 
                                 "maleYes (Alcohol Involved)", 
                                 "femaleYes (Alcohol Involved)"))) %>% 
  group_by(Age, grp) %>%
  summarise(Accident_count = n()) %>% 
  mutate(perc = Accident_count / sum(Accident_count) * 100) %>%
  mutate(grp = fct_recode(grp,
                          "Female, No Alcohol" = "femaleNo (Alcohol Not Involved)",
                          "Male, No Alcohol" = "maleNo (Alcohol Not Involved)",
                          "Male, Alcohol Involved" = "maleYes (Alcohol Involved)",
                          "Female, Alcohol Involved" = "femaleYes (Alcohol Involved)"))


AgeSexAlcOne <- ggplot(Names_Changed %>% filter(!is.na(Sex)) %>% filter(!is.na(Alcohol_involvement)) %>% filter(!is.na(Age)), aes(x = Age, fill =  paste0(Sex,Alcohol_involvement))) +
  geom_bar(stat = "count", position = "stack")

AgeSexAlcTwo <- ggplot(LongAlcSexAge, aes(x = Age, y = perc, fill = grp)) +
  geom_col(position = "stack") +
  scale_fill_manual(values = c("coral1", "dodgerblue1", "dodgerblue4", "coral4")) +
  labs(title = "Percent of Accidents by Age, Sex, and Intoxication Level",
       x = "Age",
       y = "Number of Accidents",
       fill = "Group") +
  theme_minimal()

gridExtra::grid.arrange(AgeSexAlcOne, AgeSexAlcTwo)

```


### Graph 6: Number of Accidents by Sex
```{r Graph 6: Number of Accidents by Sex}
ggplot(Names_Changed %>% filter(!is.na(Sex)), aes(x = Sex, fill = Injury_Severity_Basic)) +
geom_bar() +
ggtitle("Number of Accidents by Sex")
```

### Graph 11: Age Distribution of Persons Involved in Accidents
```{r Graph 11: Age Distribution of Persons Involved in Accidents}
ggplot(Names_Changed, aes(x = Age)) +
geom_histogram(binwidth = 1) +
labs(x = "Age", y = "Count", title = "Age Distribution of Persons Involved in Accidents")
```

### Graph 22: Distribution of Age by Sex Involved in Accidents
```{r Graph 22: Distribution of Age by Sex Involved in Accidents}
ggplot(Names_Changed, aes(x = Sex, y = Age)) +
geom_boxplot() +
labs(x = "Sex", y = "Age", title = "Distribution of Age by Sex Involved in Accidents")
```

### Graph 33: Number of vehicles and people
```{r Plot33, fig.cap="Scatter plot showing the relationship between the number of vehicles and the number of persons involved in accidents."}
ggplot(Names_Changed, aes(x= Number_of_vehicles_involved, y = Number_of_persons_involved))+
  geom_point(alpha = 0.1)
```

### Graph 34: Density plot of Age
```{r Plot34, fig.cap="Density plot showing the distribution of age of individuals involved in accidents."}
ggplot(data = Names_Changed, aes(x = Age)) +
  geom_density(fill = "lightblue", alpha = 0.6) +
  theme_minimal() +
  labs(x = "Age", y = "Density")

```

### Graph 35: Age vs Number of Persons Involved by Sex
```{r Plot35, fig.cap="Scatter plot showing the relationship between age and number of persons involved in accidents, separated by sex."}
ggplot(data = Names_Changed, aes(x = Age, y = Number_of_persons_involved)) +
  geom_point(alpha = 0.2) +
  facet_wrap(~ Sex) +
  theme_minimal() +
  labs(x = "Age", y = "Number of Persons Involved")
```

Graph 43: Ridgeline plot of the number of accidents by state and hour. RI and DC have some issues with early morning accidents!
``` {R Graph 43, fig.cap="Ridgeline plot of number of accidents by state and hour"}
ggplot(Names_Changed, aes(x = Accident_hour, y = state_name)) +
    ggridges::geom_density_ridges() +
    labs(title = "Ridgeline Plot: Accident Hour", x = "Hour", y = "State") +
    theme_ridges()
```

### Graph 44: Boxplot of Age by Injury Severity
``` {r Graph 44, fig.cap="Boxplot of Age by Injury Severity"}
ggplot(Names_Changed, aes(x = Injury_severity, y = Age, fill = Injury_severity)) +
  geom_boxplot() +
  labs(title = "Boxplot of Age by Injury Severity", x = "Injury Severity", y = "Age") +
  theme_minimal()
```

### Graph 45: Normality: Q-Q plot of Age
``` {r Graph 45, Normality: Q-Q plot of Age}
ggplot(Names_Changed, aes(sample = Age)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  labs(title = "Q-Q Plot of Age", x = "Theoretical Quantiles", y = "Sample Quantiles") +
  theme_minimal()
```


# Accident Characteristics

### Graph 25: Distribution of Age by Manner of Collision
```{r Graph 25: Distribution of Age by Manner of Collision}
ggplot(Names_Changed, aes(x = Manner_of_collision, y = Age)) +
geom_boxplot() +
labs(x = "Manner of collision", y = "Age", title = "Distribution of Age by Manner of Collision")
```

### Graph 28: Relationship between Hour of Day and Age of Persons Involved in Accidents, Colored by Injury Severity and Faceted by Sex
```{r Graph 28: Relationship between Hour of Day and Age of Persons Involved in Accidents, Colored by Injury Severity and Faceted by Sex}
ggplot(Names_Changed %>% filter(!is.na(Sex)), aes(x = Accident_hour, y = Age, color = Injury_Severity_Basic)) +
  geom_point(alpha = 0.005) +
  facet_wrap(~ Sex) +
  labs(x = "Hour of day", y = "Age", color = "Injury severity", title = "Relationship between Hour of Day and Age of Persons Involved in Accidents, Colored by Injury Severity and Faceted by Sex")+
  guides(color = guide_legend(override.aes = list(alpha = 1)))
```

### Graph 29: Visualizing the Frequency of Accidents Throughout the Year
```{r Graph 29: Visualizing the Frequency of Accidents Throughout the Year}
accidents_per_day <- Names_Changed %>%
mutate(DoY = yday(Datetime), Month = month(Datetime), Day = day(Datetime), Hour = hour(Datetime)) %>%
group_by(Month, Day, Hour) %>%
summarize(count = n()) %>%
ungroup()

ggplot(accidents_per_day, aes(x = Day, y = Month, fill = count)) +
geom_tile(color = "white") +
scale_y_continuous(trans = 'reverse', breaks = 1:12, labels = month.abb) +
labs(x = "Day", y = "Month", fill = "Accidents", title = "Visualizing the Frequency of Accidents Throughout the Year") +
theme_minimal() +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


### Graph 7: Number of Accidents with Alcohol Involvement (Should go into this more by selecting just accidents involving alcohol)
```{r Graph 7: Number of Accidents with Alcohol Involvement}
ggplot(Names_Changed %>% filter(!is.na(Alcohol_involvement)), aes(x = Alcohol_involvement, fill = Sex)) +
geom_bar() +
ggtitle("Number of Accidents with Alcohol Involvement")
```

Graph 8: Distribution of Injury Severity
```{r Graph 8: Distribution of Injury Severity}
ggplot(Names_Changed %>% filter(!is.na(Injury_severity)), aes(x = Injury_severity)) +
geom_bar() +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
ggtitle("Distribution of Injury Severity")
```

### Graph 9: Number of Accidents by Manner of Collision
```{r Graph 9: Number of Accidents by Manner of Collision}
ggplot(Names_Changed %>% filter(!is.na(Manner_of_collision)), aes(x = Manner_of_collision)) +
geom_bar() +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
ggtitle("Number of Accidents by Manner of Collision")
```

### Graph 10: Number of Accidents by Vehicle Body Type - Somewhat redundant given what is below
```{r Graph 10: Number of Accidents by Vehicle Body Type}
accidents_by_body_type_injury_sex <- Names_Changed %>%
  filter(!is.na(Vehicle_body_type), !is.na(Injury_severity)) %>%
  group_by(Vehicle_body_type, Injury_severity, Sex, Alcohol_involvement) %>%
  summarize(n = n()) %>% 
  mutate(Vehicle_body_type = case_when(
    grepl("sedan|coupe|convertible|hatchback|automobile|compact", Vehicle_body_type, ignore.case = TRUE) ~ "Automobiles",
    grepl("motorcycle|scooter|moped", Vehicle_body_type, ignore.case = TRUE) ~ "Motorcycles and Scooters",
    grepl("van|minivan", Vehicle_body_type, ignore.case = TRUE) ~ "Vans and Minivans",
    grepl("pickup|utility|truck", Vehicle_body_type, ignore.case = TRUE) ~ "Trucks",
    grepl("bus", Vehicle_body_type, ignore.case = TRUE) ~ "Buses",
    grepl("ATV|snowmobile|golf cart|off-highway", Vehicle_body_type, ignore.case = TRUE) ~ "Specialized Vehicles",
    TRUE ~ "Unknown/Other Vehicle Types"
  )) %>% 
  filter(n > 4000) %>% 
  mutate(Injury_severity = factor(Injury_severity, levels = c("No Apparent Injury", "Possible Injury", "Suspected Minor Injury", "Suspected Serious Injury", "Fatal Injury", "Injured, Severity Unknown", "Died Prior to Crash"), ordered = TRUE))

ggplot(accidents_by_body_type_injury_sex, aes(x = Vehicle_body_type)) +
geom_bar() +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
ggtitle("Number of Accidents by Vehicle Body Type")
```

### Graph 12: Age Distribution by Injury Severity
```{r Graph 12: Age Distribution by Injury Severity}
ggplot(Names_Changed, aes(x = Injury_severity, y = Age)) +
geom_boxplot() +
labs(x = "Injury Severity", y = "Age", title = "Age Distribution by Injury Severity") +
theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

### Graph 13: Manner of Collision Distribution
```{r Graph 13: Manner of Collision Distribution}
ggplot(Names_Changed, aes(x = Manner_of_collision)) +
geom_bar() +
labs(x = "Manner of Collision", y = "Count", title = "Manner of Collision Distribution") +
theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

### Graph 15: Relationship between Age and Number of Persons Involved in Accidents
```{r Graph 15: Relationship between Age and Number of Persons Involved in Accidents}
ggplot(Names_Changed, aes(x = Age, y = Number_of_persons_involved)) +
geom_point(alpha = 0.3) +
labs(x = "Age", y = "Number of persons involved", title = "Relationship between Age and Number of Persons Involved in Accidents")
```

### Graph 16: Relationship between Age and Number of Persons Involved in Accidents
```{r Graph 16: Relationship between Age and Number of Persons Involved in Accidents}
ggplot(Names_Changed, aes(x = Age, y = Number_of_persons_involved)) +
geom_point(alpha = 0.3) +
labs(x = "Age", y = "Number of persons involved", title = "Relationship between Age and Number of Persons Involved in Accidents")
```

### Graph 20: Relationship between Age and Time of Day When Accidents Occur - why 24 and 0 different? FIX THIS
```{r Graph 20: Relationship between Age and Time of Day When Accidents Occur}
# ggplot(Names_Changed, aes(x = Accident_hour, y = Age)) +
# geom_point(alpha = 0.003) +
# labs(x = "Hour of day", y = "Age", title = "Relationship between Age and Time of Day When Accidents Occur")
ggplot(Names_Changed, aes(x = Accident_hour, y = Age)) +
  geom_point(alpha = 0.003) +
  labs(x = "Hour of day", y = "Age", title = "Relationship between Age and Time of Day When Accidents Occur") +
  scale_alpha(trans = "log", range = c(0.005, 0.5))

```

### Graph 21: Number of Accidents by Vehicle Body Type and Injury Severity
```{r Graph 21: Number of Accidents by Vehicle Body Type and Injury Severity}
ggplot(accidents_by_body_type_injury_sex, aes(x = Vehicle_body_type, fill = Injury_severity)) +
geom_bar(position = "stack") +
scale_fill_brewer(type = "div", palette = "RdYlBu", direction = -1) +
labs(x = "Vehicle body type", y = "Number of accidents", title = "Number of Accidents by Vehicle Body Type and Injury Severity")+
theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

### Graph 23: Number of Accidents by Month and Injury Severity
```{r Graph 23: Number of Accidents by Month and Injury Severity}
ggplot(Names_Changed, aes(x = Month_Name, fill = Injury_severity)) +
geom_bar() +
labs(x = "Month", y = "Number of accidents", title = "Number of Accidents by Month and Injury Severity") +
theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

### Graph 24: Distribution of Number of Persons Involved in Accidents
```{r Graph 24: Distribution of Number of Persons Involved in Accidents}
ggplot(subset(Names_Changed, Number_of_persons_involved < 10), aes(x = Number_of_persons_involved)) +
geom_density() +
labs(x = "Number of persons involved", y = "Density", title = "Distribution of Number of Persons Involved in Accidents")
```

### Graph 26: Heatmap of Accidents by Hour and Day of the Week
```{r Graph 26: Heatmap of Accidents by Hour and Day of the Week}
accidents_by_hour_weekday <- Names_Changed %>%
group_by(hour = hour(Datetime), weekday = wday(Datetime, label = TRUE)) %>%
summarize(n = n())

ggplot(accidents_by_hour_weekday, aes(x = hour, y = weekday, fill = n)) +
geom_tile() +
scale_fill_gradient(low = "#f7f7f7", high = "#e31a1c") +
labs(x = "Hour of day", y = "Day of week", fill = "Number of accidents", title = "Heatmap of Accidents by Hour and Day of the Week")
```

### Graph 27: Accidents by Vehicle Body Type, Injury Severity, and Sex (double check classifications with someone else)
```{r Graph 27: Accidents by Vehicle Body Type, Injury Severity, and Sex}

ggplot(accidents_by_body_type_injury_sex, aes(x = Vehicle_body_type, y = n, fill = Injury_severity))+
geom_col(position = "dodge") +
facet_wrap(~ Sex, scales = "free_y") +
  scale_fill_brewer(type = "div", palette = "RdYlBu", direction = -1) +
labs(x = "Vehicle body type", y = "Number of accidents", fill = "Injury severity", title = "Accidents by Vehicle Body Type, Injury Severity, and Sex")+
theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

### Graph 30: Analyzing the Relationship Between Time and Accidents Across Different Months
```{r Graph 30: Analyzing the Relationship Between Time and Accidents Across Different Months}
ggplot(accidents_per_day, aes(x = Day, y = Hour, fill = count - mean(count))) +
geom_tile(width = 0.5) +
scale_y_reverse() +
scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
facet_wrap(~ month(Month, label = TRUE)) +
theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust = 1)) +
labs(x = "Day", y = "Time", fill = "Accidents", title = "Analyzing the Relationship Between Time and Accidents Across Different Months")
```

### Graph 32: Time-based analysis - Seasonal decomposition plot
```{r Plot32, fig.cap="Seasonal decomposition plot showing the trend of accidents over time, highlighting any seasonality in the data."}
monthly_accidents <- Names_Changed %>%
  mutate(Month = floor_date(Datetime, "month")) %>%
  count(Month)

ggplot(monthly_accidents, aes(x = Month, y = n)) +
  geom_line() +
  theme_minimal() +
  labs(x = "Year", y = "Number of Accidents")
```


### Graph 36: Violin plot of Age by Sex
```{r Plot36, fig.cap="Violin plot showing the distribution of age of individuals involved in accidents, separated by sex."}
ggplot(data = Names_Changed, aes(x = Sex, y = Age, fill = Sex)) +
  geom_violin() +
  theme_minimal() +
  labs(x = "Sex", y = "Age")
```

### Graph 37: Hexbin plot of Age vs Number of Persons Involved
```{r Plot37, fig.cap="Hexbin plot showing the density of points in a hexagonal grid, with the x-axis representing age and y-axis representing the number of persons involved in accidents."}
ggplot(data = Names_Changed, aes(x = Age, y = Number_of_persons_involved)) +
  geom_hex(bins = 30) +
  theme_minimal() +
  labs(x = "Age", y = "Number of Persons Involved")
```

### Graph 38: Ridge plot of Age distribution by Injury Severity (Why are these different?)
```{r Plot38, fig.cap="Ridge plot showing the distribution of age of individuals involved in accidents, separated by injury severity."}
library(ggridges)
ggplot(data = Names_Changed, aes(x = Age, y = Injury_severity, fill = Injury_severity)) +
  geom_density_ridges() +
  theme_minimal() +
  labs(x = "Age", y = "Injury Severity")

ggplot(data = Names_Changed, aes(x = Age, y = ..count.., fill = Injury_severity)) +
  stat_density(geom = "line") +
  scale_fill_discrete(name = "Injury Severity") +
  labs(x = "Age", y = "Count of Rows") +
  theme_minimal()+
  facet_wrap(~ Injury_severity, scales = "free")+
  xlim(0, 100)

```

### Graph 39: Bar plot of Number of Accidents by Vehicle Body Type, faceted by Alcohol Involvement (Double check `accidents_by_body_type_injury_sex` to make sure this is working properly)
```{r Plot39, fig.cap="Bar plot showing the number of accidents by vehicle body type, faceted by alcohol involvement."}
ggplot(data = accidents_by_body_type_injury_sex, aes(x = Vehicle_body_type, y = n)) +
  geom_col() +
  facet_wrap(~ Alcohol_involvement) +
  theme_minimal() +
  labs(x = "Vehicle Body Type", y = "Number of Accidents") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

### Graph 40: Scatter plot with jitter for the Number of Persons Involved in Accidents by Hour, colored by Sex
```{r Plot40, fig.cap="Scatter plot showing the relationship between the hour of the day and the number of persons involved in accidents, colored by sex."}
ggplot(data = Names_Changed, aes(x = Accident_hour, y = Number_of_persons_involved, color = Sex)) +
  geom_jitter(alpha = 0.1, width = 0.2, height = 0.2) +
  theme_minimal() +
  labs(x = "Hour of the Day", y = "Number of Persons Involved")

```

### Graph 46: Linearity: Scatterplot of Age vs. Number_of_persons_involved with a LOESS fit (takes forever to render)
``` {r Graph 46, Linearity: Scatterplot of Age vs. Number_of_persons_involved with a LOESS fit}
# ggplot(Names_Changed, aes(x = Age, y = Number_of_persons_involved)) +
#   geom_point(alpha = 0.2, aes(color = Sex)) +
#   geom_smooth(method = "loess", se = FALSE, color = "red") +
#   labs(title = "Scatterplot of Age vs. Number of Persons Involved with LOESS fit", x = "Age", y = "Number of Persons Involved") +
#   theme_minimal()

```

### Graph 47: Homoscedasticity: Residual plot (using a linear model as an example) (takes forever to render)
``` {r Graph 47, Residual plot}
# # Fit a linear model
# model <- lm(Number_of_persons_involved ~ Age, data = Names_Changed)
# 
# # Create a residual plot
# ggplot(data.frame(residuals = resid(model), fitted = fitted(model)), aes(x = fitted, y = residuals)) +
#   geom_point(alpha = 0.2) +
#   geom_smooth(se = FALSE, color = "red", method = "loess") +
#   labs(title = "Residual Plot", x = "Fitted Values", y = "Residuals") +
#   theme_minimal()

```

### Graph 48: Density plot of Age (to check the distribution)
``` {r Graph 48, Density plot of Age}
ggplot(Names_Changed, aes(x = Age)) +
  geom_density(fill = "steelblue", alpha = 0.5) +
  labs(title = "Density Plot of Age", x = "Age", y = "Density") +
  theme_minimal()

```



# Next split into states or reigions like New England where hours of daylight will change and may cause more accidents 
``` {r Split into states}

Names_Changed <- Names_Changed %>%
  mutate(region = case_when(
    state_name %in% c("Maine", "New Hampshire", "Vermont", "Massachusetts", "Rhode Island", "Connecticut", "New York", "Pennsylvania", "New Jersey") ~ "Northeast",
    state_name %in% c("Wisconsin", "Michigan", "Illinois", "Indiana", "Ohio", "Minnesota", "Iowa", "Missouri", "North Dakota", "South Dakota", "Nebraska", "Kansas") ~ "Midwest",
    state_name %in% c("Delaware", "Maryland", "District of Columbia", "Virginia", "West Virginia", "North Carolina", "South Carolina", "Georgia", "Florida", "Kentucky", "Tennessee", "Mississippi", "Alabama", "Oklahoma", "Texas", "Arkansas", "Louisiana") ~ "South",
    state_name %in% c("Montana", "Idaho", "Wyoming", "Colorado", "New Mexico", "Arizona", "Utah", "Nevada", "Washington", "Oregon", "California", "Alaska", "Hawaii") ~ "West",
    TRUE ~ NA_character_
  ))

         
```


### Graph 1: Number of Accidents per State
```{r Graph 1: Number of Accidents per State}
ggplot(Names_Changed %>% filter(!is.na(state_name)), aes(x = state_name)) +
geom_bar() +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
ggtitle("Number of Accidents per State")
```



# Do teens have more accidents on weekends? (Subset data or mutate a column identifying weekends and facet)
``` {r Teens}
library(ggplot2)

# Filter the data to only include accidents involving teens (ages 16-19)
teens <- Names_Changed %>% filter(Age >= 16 & Age <= 19)

# Plot 1: Number of accidents by day of the week for teens
P1Teen <- ggplot(teens, aes(x = Accident_weekday)) +
  geom_bar() +
  labs(title = "Number of accidents by day of the week for teens",
       x = "Day of the week",
       y = "Number of accidents") +
  facet_wrap( ~ region)

# Plot 2: Proportion of alcohol involvement by day of the week for teens
P2Teen <- ggplot(teens %>% filter(!is.na(Alcohol_involvement)), aes(x = Accident_weekday , fill = Alcohol_involvement)) +
  geom_bar(position = "fill") +
  labs(title = "Proportion of alcohol involvement by day of the week for teens",
       x = "Day of the week",
       y = "Proportion of accidents") +
  facet_wrap( ~ region)+
  theme(legend.position = "bottom", # Move legend to bottom
        legend.title = element_blank()) # Adjust size of legend key

gridExtra::grid.arrange(P1Teen, P2Teen, ncol = 2, widths = c(3, 4))

```

# What leads to fatal accidents? (Subset data or mutate a column identifying fatal and facet)




### Moving window correlation between Number_of_persons_involved and Number_of_vehicles_involved
``` {r Moving Window Statistics}

SingleWindow <- function(statistic, data, colname = NULL) {
  if (!is.data.frame(data)) {
    stop("The input data must be a dataframe.")
  }
  switch(statistic,
         "correlation" = list(Value = cor(data[,2], data[,3]), Midpoint = data[ceiling(nrow(data)/2), 1]),
         "p value" = list(Value = cor.test(data[,2], data[,3])$p.value, Midpoint = data[ceiling(nrow(data)/2), 1]),
         "OLS" = list(Value = summary(lm(data[,3] ~ data[,2]))$coefficients, Midpoint = data[ceiling(nrow(data)/2), 1]),
         "mean" = list(Value = mean(data[[colname]]), Midpoint = data[ceiling(nrow(data)/2), 1]), # Second column only
         stop("The input statistic must be one of 'correlation', 'p value', 'mean', or 'OLS'.")
  )
}


MovingWindow <- function(data, posix_col, col1, col2, window_days, step_size, statistic) {
  # Ensure the input POSIX column is in POSIXct format
  data[[posix_col]] <- as.POSIXct(data[[posix_col]])
  
  # Calculate the minimum and maximum POSIX values in the dataset
  min_date <- min(data[[posix_col]])
  max_date <- max(data[[posix_col]])
  
  # Convert window_days and step_size to seconds
  window_seconds <- window_days * 24 * 60 * 60
  step_seconds <- step_size * 24 * 60 * 60
  
  # Set the starting date for the moving window
  current_date <- min_date
  
  results = list()
  # Iterate through the dataset using the moving window
  while (current_date + window_seconds <= max_date) {
    # Filter the data within the moving window
    window_data <- data[data[[posix_col]] >= current_date & data[[posix_col]] <= current_date + window_seconds, c(posix_col, col1, col2)]
    
    # Select the posix_col, col1, and col2 using dplyr and set it equal to win_val
    win_val <- window_data %>%
      select(all_of(c(posix_col, col1, col2)))
    
    # Print the win_val dataframe for the current window
    # print(colnames(win_val))
    
    
    if (statistic != "mean") {
      result <- SingleWindow(statistic, win_val)
    }
    if (statistic == "mean") {
      result <- SingleWindow(statistic, win_val, colname = col1)
    }
    
    results <- rbind(results, data.frame(DateTime = current_date,
                                         Value = result$Value[1],
                                         Midpoint = as.POSIXct(result$Midpoint$Datetime)))
    
    # Move the window by step_size
    current_date <- current_date + step_seconds
    
  }
  
  # print(results)
  ggplot(data = results, aes(x=Midpoint,Value))+
    geom_point()
  
}

MovingWindow(Names_Changed, "Datetime", "Number_of_persons_involved", "Number_of_vehicles_involved", 30, 15, "correlation")

DayMeanFind <- Names_Changed %>%
  group_by(Datetime) %>%
  summarize(rows_on_date = n()) %>%
  filter(!is.na(rows_on_date))%>%
  mutate(rows_on_date = as.numeric(rows_on_date))

MovingWindow(DayMeanFind, "Datetime", "rows_on_date", "rows_on_date", 30, 15, "mean")

```











